<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPA - The Phone Arcade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-bg { background-color: rgba(0,0,0,0.5); }
        .tab-button.active { border-color: #eab308; color: #eab308; }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .pop { animation: pop 0.2s ease-out; }
        .header-top-bar { background-color: #eab308; }
        .main-nav { background-color: #f3f4f6; border-bottom: 1px solid #e5e7eb; }
        .category-sidebar a { display: block; padding: 8px 16px; border-bottom: 1px solid #eee; }
        .category-sidebar a:hover { background-color: #f9fafb; color: #d97706; }
        .category-sidebar h3 { background-color: #eab308; color: white; padding: 12px 16px; }
        .product-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }
        .product-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: #eab308;
        }
        .product-card .product-image-container {
            position: relative;
            overflow: hidden;
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }
        .product-card .product-image {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            mix-blend-mode: multiply;
        }
        .product-card .action-icons {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 20;
            opacity: 0;
            transform: translateX(-20px);
            transition: all 0.3s ease-out;
        }
        .product-card:hover .action-icons {
            opacity: 1;
            transform: translateX(0);
        }
        .product-card .action-icons button, .product-card .action-icons a {
            background-color: white;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: #374151;
            transition: all 0.2s ease;
        }
        .product-card .action-icons button:hover, .product-card .action-icons a:hover {
            background-color: #eab308;
            color: white;
        }
        .brand-tab.active {
            border-bottom: 2px solid #eab308;
            color: #eab308;
            font-weight: 600;
        }
        .product-info-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            text-align: left;
        }
        .product-card .product-name {
            min-height: 40px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: left;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }
        .product-description-snippet {
            min-height: 36px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            text-align: left;
        }
        .product-card .price-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        .category-explorer-card {
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        .category-explorer-card:hover {
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
             border-color: #eab308;
        }
       .category-explorer-card img {
            aspect-ratio: 4 / 3;
            object-fit: contain;
            /* mix-blend-mode: multiply; */ /* <-- මේ line එක අයින් කරන්න */
        }
        .site-footer {
            background-color: #f8f8f8;
            color: #555;
            font-size: 0.875rem;
        }
        .site-footer h4 {
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
            text-transform: uppercase;
        }
        .site-footer a {
            color: #555;
            transition: color 0.2s ease;
        }
        .site-footer a:hover {
            color: #d97706;
        }
        .footer-bottom {
            background-color: #eee;
            color: #666;
            font-size: 0.75rem;
        }
        .footer-bottom .fa-cc-visa { color: #1A1F71; }
        .footer-bottom .fa-cc-amex { color: #007BC1; }
        .footer-bottom .fa-cc-paypal { color: #003087; }
        .footer-bottom .fa-cc-mastercard { color: #EB001B; }
        .footer-bottom .fa-cc-discover { color: #FF6600; }
        .fixed-chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background-color: #eab308;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .fixed-chat-button:hover {
            transform: scale(1.1);
        }
        .fixed-chat-button i {
            font-size: 28px;
        }
        #cart-drawer {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        #cart-modal-bg {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #cart-modal:not(.hidden) #cart-drawer {
            transform: translateX(0);
        }
        #cart-modal:not(.hidden) #cart-modal-bg {
            opacity: 1;
        }
        #search-results-area {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
        }
        #search-results-area.hidden {
            display: none;
        }

        .loading-spinner {
    border: 4px solid #f3f3f3; /* Light grey */
    border-top: 4px solid #eab308; /* Amber color */
    border-radius: 50%;
    width: 40px; /* Size එක හදාගන්න */
    height: 40px; /* Size එක හදාගන්න */
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

    </style>
</head>
<body class="bg-slate-50">

    <div id="auth-modal" class="fixed inset-0 modal-bg z-50 flex items-center justify-center hidden"> <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4"> <div class="p-4 border-b"> <div class="flex justify-between items-center"> <h2 class="text-xl font-bold text-slate-700">Welcome!</h2> <button id="close-modal-btn" class="text-slate-500 hover:text-slate-800 text-3xl leading-none">&times;</button> </div> </div> <div class="p-2 bg-slate-100 flex gap-2"> <button id="login-tab-btn" class="tab-button active flex-1 bg-white p-2 rounded-md font-semibold border-b-2">Login</button> <button id="signup-tab-btn" class="tab-button flex-1 bg-white p-2 rounded-md font-semibold text-slate-500 border-b-2 border-transparent">Sign Up</button> </div> <div class="p-6" style="max-height: 70vh; overflow-y: auto;"> <form id="login-form" class="space-y-4"> <input type="email" id="login-email" placeholder="Email" required class="w-full p-3 border rounded-md"> <input type="password" id="login-password" placeholder="Password" required class="w-full p-3 border rounded-md"> <button type="submit" class="w-full bg-amber-600 text-white p-3 rounded-md hover:bg-amber-700">Login</button> <p id="login-error" class="text-red-500 text-sm text-center"></p> </form> <form id="signup-form" class="space-y-4 hidden"> <input type="text" id="signup-name" placeholder="Full Name" required class="w-full p-3 border rounded-md"> <input type="email" id="signup-email" placeholder="Email" required class="w-full p-3 border rounded-md"> <input type="password" id="signup-password" placeholder="Password" required class="w-full p-3 border rounded-md"> <input type="tel" id="signup-phone" placeholder="Phone Number" required class="w-full p-3 border rounded-md"> <input type="text" id="signup-address" placeholder="Address" required class="w-full p-3 border rounded-md"> <div class="grid grid-cols-2 gap-4"> <input type="text" id="signup-city" placeholder="City" required class="w-full p-3 border rounded-md"> <input type="text" id="signup-district" placeholder="District" required class="w-full p-3 border rounded-md"> </div> <input type="text" id="signup-postal-code" placeholder="Postal Code" required class="w-full p-3 border rounded-md"> <button type="submit" class="w-full bg-amber-600 text-white p-3 rounded-md hover:bg-amber-700">Create Account</button> <p id="signup-error" class="text-red-500 text-sm text-center"></p> </form> </div> </div> </div>

     <div id="cart-modal" class="fixed inset-0 z-50 hidden">

          <div id="cart-modal-bg" class="fixed inset-0 modal-bg"></div>

          <div id="cart-drawer" class="fixed top-0 right-0 h-full bg-white shadow-xl w-full max-w-md flex flex-col">

               <div class="p-4 flex justify-between items-center border-b flex-shrink-0">
                    <h2 class="text-xl font-semibold text-slate-800">Shopping cart</h2>
                    <button id="close-cart-btn" class="text-slate-500 hover:text-slate-800 text-sm flex items-center gap-1">
                         <i class="fas fa-times"></i> Close
                    </button>
               </div>

               <div class="flex-grow p-6 overflow-y-auto">
                    <div id="cart-items-container" class="divide-y divide-slate-100">
                         <p class="text-slate-500 py-6 text-center">Your cart is empty.</p>
                    </div>
               </div>

               <div class="p-6 border-t bg-slate-50 flex-shrink-0">
                    <div class="flex justify-between items-center mb-2">
                         <span class="text-lg font-medium text-slate-600">Subtotal:</span>
                         <span id="cart-total" class="text-xl font-bold text-amber-600">Rs. 0.00</span>
                    </div>
                    <p class="text-sm text-center text-slate-500 mb-2">Your order qualifies for free shipping!</p>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-4 overflow-hidden">
                         <div class="bg-gradient-to-r from-amber-400 to-amber-600 h-2 rounded-full" style="width: 100%"></div>
                    </div>
                    <div class="flex flex-col gap-3">
                         <a href="cart.html" class="w-full text-center bg-white border-2 border-amber-600 text-amber-600 p-3 rounded-lg hover:bg-amber-50 font-bold text-base">
                              VIEW CART
                         </a>
                         <a href="checkout.html" class="w-full text-center bg-amber-600 text-white p-3 rounded-lg hover:bg-amber-700 font-bold text-base">
                              CHECKOUT
                         </a>
                    </div>
               </div>

          </div>
     </div>
     <div id="tracking-modal" class="fixed inset-0 modal-bg z-50 flex items-center justify-center hidden"> <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4" style="max-height: 90vh;"> <div class="p-6 flex justify-between items-center border-b"> <h2 class="text-3xl font-bold text-slate-800">My Orders</h2> <button id="close-tracking-btn" class="text-slate-500 hover:text-slate-800 text-3xl leading-none">&times;</button> </div> <div id="tracking-items-container" class="p-6 flex flex-col" style="max-height: calc(90vh - 100px); overflow-y: auto;"> <p class="text-slate-500 text-center">Loading your orders...</p> </div> </div> </div>


     <header class="sticky top-0 z-40 bg-white shadow-md">
          <div class="header-top-bar text-white text-xs py-1"> <div class="container mx-auto px-4 flex justify-between items-center"> <span>Your Ultimate Destination</span> <div class="flex items-center space-x-4"> <a href="#" class="hover:text-gray-300"><i class="fab fa-facebook-f"></i></a> <a href="#" class="hover:text-gray-300"><i class="fab fa-instagram"></i></a> <a href="#" class="hover:text-gray-300"><i class="fab fa-whatsapp"></i></a> <span class="border-l border-amber-400 h-4"></span> <a href="#" class="hover:underline">NEWSLETTER</a> <a href="#" class="hover:underline">CONTACT US</a> <a href="#" class="hover:underline">FAQS</a> </div> </div> </div> <div class="py-4 border-b"> <div class="container mx-auto px-4 flex justify-between items-center gap-6"> <a href="index.html" id="logo-btn" class="flex-shrink-0">
                   <img src="LOGO.png" alt="TPA - The Phone Arcade" class="h-10 md:h-12">
                   </a> <div class="flex-grow flex border border-gray-300 rounded-md overflow-hidden"> <input type="text" id="search-bar" placeholder="Search for products" class="w-full px-4 py-2 focus:outline-none text-sm">
                   <select id="search-category-dropdown" class="border-l border-gray-300 px-2 text-sm text-gray-600 focus:outline-none bg-gray-50 hidden md:block">
                        <option value="all">ALL CATEGORIES</option>
                   </select>
                   <button id="search-icon-btn" class="bg-gray-100 px-4 text-gray-600 hover:bg-gray-200"> <i class="fas fa-search"></i> </button> </div> <div class="flex items-center space-x-3 md:space-x-4 text-gray-700"> <div id="auth-links" class="text-sm hidden md:block"> <button id="login-btn-nav" class="hover:text-amber-700">LOGIN</button> / <button id="signup-btn-nav" class="hover:text-amber-700">REGISTER</button> </div>
                    <div id="user-info" class="hidden items-center space-x-3 text-sm">
                    <a href="profile.html" class="flex items-center gap-2 hover:text-amber-700 p-1 rounded-md">
                         <i class="fas fa-user-circle text-2xl text-gray-500"></i>
                         <span id="user-email" class="hidden lg:inline font-medium text-gray-700"></span>
                    </a>
                    <span class="border-l h-5 self-center"></span>
                    <button id="logout-btn-nav" class="hover:text-red-600 text-gray-600 text-xs font-medium uppercase tracking-wider hover:bg-gray-100 p-2 rounded-md">Logout</button>
               </div> 
                    <span class="border-l h-5 self-center hidden md:block"></span> <a href="#" title="Wishlist" class="relative hover:text-amber-700"> <i class="fas fa-heart text-xl"></i> <span class="absolute -top-1 -right-1 bg-amber-600 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">0</span> </a> <a href="#" title="Compare" class="relative hover:text-amber-700 hidden md:block"> <i class="fas fa-exchange-alt text-xl"></i> <span class="absolute -top-1 -right-1 bg-amber-600 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">0</span> </a> <a href="cart.html" id="cart-icon" title="Cart" class="relative hover:text-amber-700 flex items-center"> <i class="fas fa-shopping-bag text-xl"></i> <span id="cart-count-badge" class="absolute -top-1 -right-2 bg-amber-600 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">0</span> <span class="ml-2 text-sm font-semibold hidden md:inline">Rs.0.00</span> </a> <button id="tracking-icon-btn" title="Track My Orders" class="relative hover:text-amber-700"> <i class="fas fa-clipboard-list text-xl"></i> </button> </div> </div> </div> <nav class="main-nav hidden md:block"> <div class="container mx-auto px-4 flex justify-between items-center h-12"> <div class="flex space-x-6 text-sm font-medium"> <a href="index.html" class="text-amber-600 hover:text-gray-900">HOME</a> <a href="#" class="text-gray-700 hover:text-amber-700">SHOP</a> <a href="#" class="text-gray-700 hover:text-amber-700">ABOUT US</a> <a href="#" class="text-gray-700 hover:text-amber-700">CONTACT US</a> <a href="#" class="text-gray-700 hover:text-amber-700">STORE</a> </div> <a href="#" class="text-amber-600 font-semibold text-sm flex items-center gap-1 hover:text-gray-900"> <i class="fas fa-heart text-xs"></i> SPECIAL OFFERS </a> </div> </nav>
     </header>

     <main class="container mx-auto p-4 flex flex-col md:flex-row gap-6">

          <aside class="w-full md:w-1/5 bg-white shadow rounded overflow-hidden category-sidebar self-start">
               <h3 class="text-sm font-bold uppercase flex items-center justify-between">
                    <span><i class="fas fa-bars mr-2"></i>Browse Categories</span>
                    <i class="fas fa-chevron-down mr-4 md:hidden" id="category-toggle-btn"></i>
               </h3>
               <div id="category-sidebar-list" class="md:block"> <p class="p-4 text-slate-500">Loading categories...</p>
               </div>
          </aside>

          <div class="flex-1">

               <div id="banner-placeholder" class="bg-gray-200 rounded-lg shadow-md mb-8 overflow-hidden">
                    <img src="banner.png" alt="TPA Banner" class="w-full h-auto object-cover hidden lg:block">
                    <img src="banner.png" alt="TPA Banner" class="w-full h-auto object-cover hidden md:block lg:hidden">
                    <img src="banner.png" alt="TPA Banner" class="w-full h-auto object-cover block md:hidden">
               </div>

               <div id="search-results-area" class="hidden">
                    <h2 id="search-results-title" class="text-2xl font-bold text-gray-800 mb-4">Search Results</h2>
                    <img id="search-category-banner" src="" alt="Category Banner" class="w-full h-auto object-cover rounded-lg shadow-md mb-6 hidden" style="max-height: 300px;">
                    <div id="search-results-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                         <p class="col-span-full text-center text-gray-500 py-5">Searching...</p>
                    </div>
               </div>

                <section id="trusted-brands-section" class="mb-8">
                    <div class="flex justify-center items-center gap-6 border-b pb-2 mb-6">
                         <button class="brand-tab active px-3 py-1 hover:text-amber-700 hover:border-amber-700 transition-colors duration-200" data-brand="Samsung">SAMSUNG</button>
                         <button class="brand-tab text-gray-500 px-3 py-1 hover:text-amber-700 hover:border-amber-700 transition-colors duration-200" data-brand="Google">GOOGLE</button>
                         <button class="brand-tab text-gray-500 px-3 py-1 hover:text-amber-700 hover:border-amber-700 transition-colors duration-200" data-brand="Huawei">HUAWEI</button>
                    </div>
               </section>
          </div>

     </main>


     <div class="container mx-auto p-4 -mt-6">
          <section id="product-grid-section" class="w-full pb-6">
              
             <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                    <p class="col-span-full text-center text-gray-500 py-10">Loading featured products...</p>
               </div>
          </section>
     </div>

     <section id="explore-categories" class="container mx-auto p-4 my-10">
          <div class="text-center mb-8">
               <p class="text-sm text-gray-500 mb-1">Everything you're looking for, organized by category</p>
               <h2 class="text-3xl font-bold text-gray-800 mb-2">Explore Our Categories</h2>
               <p class="text-gray-600">Explore a wide range of products organized for your convenience</p>
          </div>
          <div id="category-explorer-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
               <p class="text-slate-500 col-span-full text-center py-5">Loading categories...</p>
          </div>
     </section>

    <div id="promo-sections-container" class="container mx-auto p-4 space-y-12 mt-10">
         <p class="text-center text-gray-500 py-10">Loading promotions...</p>
    </div>

    <section id="category-detail-section" class="container mx-auto p-4 my-10 hidden">
         <div class="text-center mb-8">
             <button id="back-to-categories-btn" class="text-amber-600 hover:text-amber-800 font-semibold mb-4 text-left w-full">
                  &larr; Back to All Categories
             </button>

             <h2 id="category-detail-title" class="text-3xl font-bold text-gray-800 mb-4"></h2>

             <img id="category-detail-banner" src="https://via.placeholder.com/1200x400?text=Category+Banner" alt="Category Banner" class="w-full h-auto object-cover rounded-lg shadow-md mb-8" style="max-height: 400px;">

             <h3 class="text-2xl font-bold text-gray-700">Products in this Category</h3>
         </div>

         <div id="category-detail-product-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
             </div>
    </section>

<footer class="site-footer border-t pt-10 mt-10">
          <div class="container mx-auto px-4 pb-10">
               <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div class="space-y-4">
                         <img src="LOGO.png" alt="TPA - The Phone Arcade" class="h-10 mb-4">
                         <p>High-quality electronics, essentials & appliances are now at your fingertips. Confirm your order now !</p>
                         <p><i class="fas fa-map-marker-alt mr-2 text-amber-700"></i> 890/a Main Street, Kaduruwela, Polonnaruwa</p>
                         <p><i class="fas fa-phone-alt mr-2 text-amber-700"></i> Phone: 077 754 9654 / 027 222 4470</p>
                         <p><i class="fas fa-envelope mr-2 text-amber-700"></i> Email: info@buyzone.lk</p>
                    </div>
                    <div>
                         <h4>Quick Links</h4>
                         <ul class="space-y-2">
                              <li><a href="index.html">Home</a></li>
                              <li><a href="shop.html">Shop</a></li>
                              <li><a href="about.html">About Us</a></li>
                              <li><a href="contact.html">Contact Us</a></li>
                              <li><a href="#">Special Offers</a></li>
                         </ul>
                    </div>
                    <div>
                         <h4>Useful Links</h4>
                         <ul class="space-y-2">
                              <li><a href="#">Privacy Policy</a></li>
                              <li><a href="#">Returns</a></li>
                              <li><a href="#">Terms & Conditions</a></li>
                              <li><a href="#">Contact Us</a></li>
                              <li><a href="#">Latest News</a></li>
                              <li><a href="#">Our Sitemap</a></li>
                         </ul>
                    </div>
                    <div>
                         <h4>My Account</h4>
                         <ul class="space-y-2">
                              <li><a href="profile.html">My Profile</a></li>
                              <li><a href="cart.html">View Cart</a></li>
                              <li><a href="#" id="footer-orders-link">Track My Orders</a></li>
                              <li><a href="wishlist.html">My Wishlist</a></li>
                         </ul>
                    </div>
               </div>
          </div>
          <div class="footer-bottom py-4 px-4">
               <div class="container mx-auto flex flex-col md:flex-row justify-between items-center text-center md:text-left">
                    <span>TPA © 2025 CREATED BY <a href="https://pixora.com" target="_blank" rel="noopener noreferrer" class="font-semibold hover:text-amber-700">PIXORA IT SOLUTIONS</a></span>
                    <div class="flex space-x-2 mt-4 md:mt-0">
                         <i class="fab fa-cc-visa text-2xl"></i>
                         <i class="fab fa-cc-amex text-2xl"></i>
                         <i class="fab fa-cc-paypal text-2xl"></i>
                         <i class="fab fa-cc-mastercard text-2xl"></i>
                         <i class="fab fa-cc-discover text-2xl"></i>
                         </div>
               </div>
          </div>
     </footer>

     <a href="https://wa.me/94777349654?text=Hello%20TPA%2C%20I'd%20like%20to%20ask%20a%20question."
         class="fixed-chat-button"
         aria-label="Chat on WhatsApp"
         target="_blank"
         rel="noopener noreferrer">
         <i class="fab fa-whatsapp"></i> </a>

     <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, setDoc, doc, limit, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
     apiKey: "AIzaSyAtvnbedBpCiRe_ZyfoB-TacrboEMgft5Y", authDomain: "mobile-shop-1c315.firebaseapp.com", projectId: "mobile-shop-1c315", storageBucket: "mobile-shop-1c315.firebasestorage.app", messagingSenderId: "689278786227", appId: "1:689278786227:web:ee06565e4a230381bf6ec6", measurementId: "G-MLDEWBBEMV"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const productsCol = collection(db, 'products');
    const categoriesCol = collection(db, 'categories');
    const usersCol = collection(db, 'users');
    const offersCol = collection(db, 'offers');
    const ordersCol = collection(db, 'orders');

    const productGrid = document.getElementById('product-grid');
    const productGridTitle = document.getElementById('product-grid-title');
    const categorySidebarList = document.getElementById('category-sidebar-list');
    const searchBar = document.getElementById('search-bar');
    const searchCategoryDropdown = document.getElementById('search-category-dropdown');
    const searchIconBtn = document.getElementById('search-icon-btn');
    const logoBtn = document.getElementById('logo-btn');
    const authModal = document.getElementById('auth-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const loginBtnNav = document.getElementById('login-btn-nav');
    const signupBtnNav = document.getElementById('signup-btn-nav');
    const logoutBtnNav = document.getElementById('logout-btn-nav');
    const loginTab = document.getElementById('login-tab-btn');
    const signupTab = document.getElementById('signup-tab-btn');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const authLinks = document.getElementById('auth-links');
    const userInfo = document.getElementById('user-info');
    const userEmailSpan = document.getElementById('user-email');
    const cartCountBadge = document.getElementById('cart-count-badge');
    const cartIcon = document.getElementById('cart-icon');

    const cartModal = document.getElementById('cart-modal');
    const cartModalBg = document.getElementById('cart-modal-bg');
    const closeCartBtn = document.getElementById('close-cart-btn');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartTotalEl = document.getElementById('cart-total');

    const trackingModal = document.getElementById('tracking-modal');
    const closeTrackingBtn = document.getElementById('close-tracking-btn');
    const trackingIconBtn = document.getElementById('tracking-icon-btn');
    const trackingItemsContainer = document.getElementById('tracking-items-container');
    const trustedBrandsSection = document.getElementById('trusted-brands-section');
    const categoryExplorerGrid = document.getElementById('category-explorer-grid');

      const categoryDetailSection = document.getElementById('category-detail-section');
      const categoryDetailTitle = document.getElementById('category-detail-title');
      const categoryDetailBanner = document.getElementById('category-detail-banner');
      const categoryDetailProductGrid = document.getElementById('category-detail-product-grid');
      const backToCategoriesBtn = document.getElementById('back-to-categories-btn');
      const exploreCategoriesSection = document.getElementById('explore-categories');
      const promoSectionsContainer = document.getElementById('promo-sections-container');
      const searchResultsArea = document.getElementById('search-results-area');
      const searchResultsTitle = document.getElementById('search-results-title');
      const searchCategoryBanner = document.getElementById('search-category-banner');
      const searchResultsGrid = document.getElementById('search-results-grid');


      const mainContentSections = [
           document.getElementById('banner-placeholder'),
           trustedBrandsSection,
           document.getElementById('product-grid-section'),
           exploreCategoriesSection,
           promoSectionsContainer,
      ];


    let currentProducts = [];
    let allActiveOffers = new Map();
    let categoriesCache = [];
    let currentCategoryFilter = 'all';
    let currentBrandFilter = null;
    let lastVisibleProduct = null;
    const productsPerPage = 12;

    onAuthStateChanged(auth, async (user) => { if (user) { if(authLinks) { authLinks.classList.add('hidden'); authLinks.classList.remove('md:block'); } if(userInfo) { userInfo.classList.remove('hidden'); userInfo.classList.add('flex'); } try { const userDocRef = doc(db, "users", user.uid); const userDoc = await getDoc(userDocRef); if (userDoc.exists() && userDoc.data().role === "admin") { if(userEmailSpan) userEmailSpan.textContent = `${user.email} (Admin)`; } else { if(userEmailSpan) userEmailSpan.textContent = user.email; } } catch (error) { console.error("Error fetching user role: ", error); if(userEmailSpan) userEmailSpan.textContent = user.email; } if(authModal) authModal.classList.add('hidden'); } else { if(authLinks) { authLinks.classList.remove('hidden', 'md:block'); authLinks.classList.add('md:block'); } if(userInfo) { userInfo.classList.add('hidden'); userInfo.classList.remove('flex'); } if(userEmailSpan) userEmailSpan.textContent = ''; } });
    const openModal = (isLogin = true) => { if(authModal) authModal.classList.remove('hidden'); if(isLogin){ if(loginTab) loginTab.click(); } else { if(signupTab) signupTab.click(); } }; if(loginBtnNav) loginBtnNav.addEventListener('click', () => openModal(true)); if(signupBtnNav) signupBtnNav.addEventListener('click', () => openModal(false)); if(closeModalBtn) closeModalBtn.addEventListener('click', () => {if(authModal) authModal.classList.add('hidden');}); if(loginTab) loginTab.addEventListener('click', () => { loginTab.classList.add('active'); if(signupTab) signupTab.classList.remove('active'); if(loginForm) loginForm.classList.remove('hidden'); if(signupForm) signupForm.classList.add('hidden'); }); if(signupTab) signupTab.addEventListener('click', () => { signupTab.classList.add('active'); if(loginTab) loginTab.classList.remove('active'); if(signupForm) signupForm.classList.remove('hidden'); if(loginForm) loginForm.classList.add('hidden'); });
    if(loginForm) loginForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; const errorP = document.getElementById('login-error'); if(errorP) errorP.textContent = ''; try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Login Error:", error); if(errorP) errorP.textContent = error.message; } }); if(signupForm) signupForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('signup-email').value; const password = document.getElementById('signup-password').value; const name = document.getElementById('signup-name').value; const phone = document.getElementById('signup-phone').value; const address = document.getElementById('signup-address').value; const city = document.getElementById('signup-city').value; const district = document.getElementById('signup-district').value; const postalCode = document.getElementById('signup-postal-code').value; const errorP = document.getElementById('signup-error'); if(errorP) errorP.textContent = ''; try { const userCredential = await createUserWithEmailAndPassword(auth, email, password); const user = userCredential.user; await setDoc(doc(db, "users", user.uid), { name: name, email: email, phone: phone, address: address, city: city, district: district, postalCode: postalCode, createdAt: serverTimestamp(), role: "customer" }); } catch (error) { console.error("Signup Error:", error); if(errorP) errorP.textContent = error.message; } }); if(logoutBtnNav) logoutBtnNav.addEventListener('click', () => { signOut(auth); });

    const getCart = () => JSON.parse(localStorage.getItem('mobileHubCart')) || [];
    const saveCart = (cart) => localStorage.setItem('mobileHubCart', JSON.stringify(cart));
    const updateCartCountBadge = () => { const cart = getCart(); const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0); const cartTotalValue = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0); if (cartCountBadge) { if (totalItems > 0) { cartCountBadge.textContent = totalItems; cartCountBadge.classList.remove('hidden'); cartCountBadge.classList.add('pop'); setTimeout(() => cartCountBadge.classList.remove('pop'), 200); } else { cartCountBadge.textContent = '0'; cartCountBadge.classList.remove('hidden', 'pop'); } } const cartTotalText = document.querySelector('#cart-icon span.md\\:inline'); if (cartTotalText) { cartTotalText.textContent = `Rs.${cartTotalValue.toLocaleString('en-US', { minimumFractionDigits: 2 })}`; } };
    const addToCart = (productId) => { const cart = getCart(); const product = currentProducts.find(p => p.id === productId); if (!product) return; const existingItem = cart.find(item => item.id === productId); if (existingItem) { existingItem.quantity++; } else { cart.push({ id: product.id, name: product.name, price: product.price, originalPrice: product.originalPrice || product.price, imageUrl: product.imageUrl, quantity: 1 }); } saveCart(cart); updateCartCountBadge(); alert(`${product.name} added to cart!`); };

    const getWishlist = () => JSON.parse(localStorage.getItem('mobileHubWishlist')) || [];
    const saveWishlist = (wishlist) => localStorage.setItem('mobileHubWishlist', JSON.stringify(wishlist));

    const updateWishlistCountBadge = () => {
         const wishlist = getWishlist();
         const totalItems = wishlist.length;
         const wishlistBadge = document.querySelector('a[title="Wishlist"] span');
         if (wishlistBadge) {
             if (totalItems > 0) {
                  wishlistBadge.textContent = totalItems;
                  wishlistBadge.classList.remove('hidden');
             } else {
                  wishlistBadge.textContent = '0';
             }
             wishlistBadge.classList.add('pop');
             setTimeout(() => wishlistBadge.classList.remove('pop'), 200);
         }
    };

    const addToWishlist = (productId) => {
         const wishlist = getWishlist();
         const product = currentProducts.find(p => p.id === productId);
         if (!product) return;

         const existingItem = wishlist.find(item => item.id === productId);
         if (existingItem) {
             alert(`${product.name} is already in your wishlist.`);
         } else {
             wishlist.push({ id: product.id, name: product.name, price: product.price, imageUrl: product.imageUrl });
             saveWishlist(wishlist);
             updateWishlistCountBadge();
             alert(`${product.name} added to wishlist!`);
         }
    };


    const renderCartModal = () => {
         const cart = getCart();
         let total = 0;
         if (!cartItemsContainer || !cartTotalEl) return;

         if (cart.length === 0) {
             cartItemsContainer.innerHTML = '<p class="text-slate-500 py-6 text-center">Your cart is empty.</p>';
             cartTotalEl.textContent = 'Rs. 0.00';
             return;
         }

         cartItemsContainer.innerHTML = cart.map(item => {
             total += item.price * item.quantity;
             return `
             <div class="flex items-center gap-4 py-4">
                  <img src="${item.imageUrl || 'https://via.placeholder.com/64'}" alt="${item.name}" class="w-16 h-16 rounded object-contain mix-blend-multiply bg-slate-100 p-1">

                  <div class="flex-grow">
                       <h4 class="font-semibold text-sm text-slate-800">${item.name}</h4>
                       <div class="flex items-center gap-2 my-1">
                            <button data-id="${item.id}" class="cart-qty-decrease w-6 h-6 font-bold rounded bg-slate-100 hover:bg-slate-200 flex items-center justify-center">-</button>
                            <span class="w-6 text-center font-bold text-sm text-slate-700">${item.quantity}</span>
                            <button data-id="${item.id}" class="cart-qty-increase w-6 h-6 font-bold rounded bg-slate-100 hover:bg-slate-200 flex items-center justify-center">+</button>
                       </div>
                       <p class="text-sm text-amber-600 font-bold">Rs. ${item.price.toLocaleString('en-US', { minimumFractionDigits: 2 })}</p>
                  </div>

                  <button data-id="${item.id}" class="cart-remove-item text-slate-400 hover:text-red-500" title="Remove Item">
                       <i class="fas fa-times text-lg"></i>
                  </button>
             </div>`;
         }).join('');

         cartTotalEl.textContent = `Rs. ${total.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
    };

    if(cartIcon) cartIcon.addEventListener('click', (e) => {
         e.preventDefault();
         renderCartModal();
         if(cartModal) cartModal.classList.remove('hidden');
    });

    if(closeCartBtn) closeCartBtn.addEventListener('click', () => {
         if(cartModal) cartModal.classList.add('hidden');
    });

    if(cartModalBg) cartModalBg.addEventListener('click', () => {
         if(cartModal) cartModal.classList.add('hidden');
    });

    if(cartModal) cartModal.addEventListener('click', (e) => {
         if (e.target === e.currentTarget || e.target === cartModalBg) {
             return;
         }

         const targetButton = e.target.closest('button, a');
         if (!targetButton) return;

         if (targetButton.href?.includes('cart.html') || targetButton.href?.includes('checkout.html')) {
             return;
         }

         const id = targetButton.dataset.id;
         if (!id) return;

         const cart = getCart();
         const item = cart.find(i => i.id === id);
         if (!item) return;

         if (targetButton.classList.contains('cart-qty-increase')) {
             item.quantity++;
             saveCart(cart);
         } else if (targetButton.classList.contains('cart-qty-decrease')) {
             if (item.quantity > 1) {
                  item.quantity--;
                  saveCart(cart);
             } else {
                  if (confirm('Remove item?')) {
                       saveCart(cart.filter(i => i.id !== id));
                  }
             }
         } else if (targetButton.classList.contains('cart-remove-item')) {
             if (confirm('Remove item?')) {
                  saveCart(cart.filter(i => i.id !== id));
             }
         }

         renderCartModal();
         updateCartCountBadge();
    });

    if(trackingIconBtn) trackingIconBtn.addEventListener('click', (e) => { e.preventDefault(); if(trackingModal) trackingModal.classList.remove('hidden'); loadUserOrders(); }); if(closeTrackingBtn) closeTrackingBtn.addEventListener('click', () => { if(trackingModal) trackingModal.classList.add('hidden'); }); const loadUserOrders = async () => { if(!trackingItemsContainer) return; trackingItemsContainer.innerHTML = '<p class="text-slate-500 text-center">Loading your orders...</p>'; const user = auth.currentUser; if (!user) { trackingItemsContainer.innerHTML = ` <div class="text-center p-8"> <h3 class="text-xl font-semibold text-slate-700 mb-4">Please Log In</h3> <p class="text-slate-500 mb-6">You need to be logged in to view your order history.</p> <button id="tracking-login-btn" class="bg-amber-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-amber-700">Login Now</button> </div>`; const trackingLoginBtn = document.getElementById('tracking-login-btn'); if (trackingLoginBtn) { trackingLoginBtn.addEventListener('click', () => { if(trackingModal) trackingModal.classList.add('hidden'); openModal(true); }); } return; } try { const q = query(ordersCol, where("userId", "==", user.uid), orderBy("createdAt", "desc")); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { trackingItemsContainer.innerHTML = ` <div class="text-center p-8"> <h3 class="text-xl font-semibold text-slate-700 mb-4">No Orders Found</h3> <p class="text-slate-500">You haven't placed any orders with us yet.</p> </div>`; return; } trackingItemsContainer.innerHTML = querySnapshot.docs.map(doc => { const order = doc.data() || {}; const orderId = doc.id; const createdDate = order.createdAt ? order.createdAt.toDate().toLocaleDateString('si-LK', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A'; const itemSummary = (order.items || []).map(item => `${item.name || 'Item'} (x${item.quantity || 1})`).join(', '); let statusColor = 'bg-slate-100 text-slate-700'; const statusLower = (order.status || 'Pending').toLowerCase(); if (statusLower === 'pending') statusColor = 'bg-yellow-100 text-yellow-800'; else if (statusLower === 'shipped' || statusLower === 'processing') statusColor = 'bg-blue-100 text-blue-800'; else if (statusLower === 'delivered') statusColor = 'bg-green-100 text-green-800'; else if (statusLower === 'cancelled') statusColor = 'bg-red-100 text-red-800'; return ` <div class="bg-white border rounded-lg p-4 mb-4 shadow-sm"> <div class="flex flex-col sm:flex-row justify-between items-start mb-3"> <div> <p class="text-xs text-slate-500">Order ID: ${orderId}</p> <p class="font-bold text-lg text-slate-800">Total: Rs. ${(order.totalAmount || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}</p> </div> <span class="text-sm font-bold px-3 py-1 rounded-full ${statusColor} mt-2 sm:mt-0">${order.status || 'Pending'}</span> </div> <p class="text-sm text-slate-600 mb-2"><strong>Placed On:</strong> ${createdDate}</p> <p class="text-sm text-slate-600 mb-3 break-words"><strong>Items:</strong> ${itemSummary || 'No items found'}</p> <div class="bg-slate-50 p-3 rounded-md"> <p class="text-sm font-semibold text-slate-700">Shipping to: ${order.customerInfo?.name || 'N/A'}</p> <p class="text-xs text-slate-500">${order.customerInfo?.address || 'N/A'}, ${order.customerInfo?.city || ''}</p> </div> </div>`; }).join(''); } catch (error) { console.error("Error fetching orders: ", error); trackingItemsContainer.innerHTML = '<p class="text-red-500 text-center">Could not load your orders. Please try again later.</p>'; } };

    const findOfferForProduct = (productId) => { for (const offer of allActiveOffers.values()) { if (offer.productIds && offer.productIds.includes(productId)) { return offer; } } return null; };

    const renderProducts = (products, gridElementId) => {
      const gridElement = document.getElementById(gridElementId);
      if (!gridElement) { console.error(`Grid element with ID ${gridElementId} not found.`); return; }

      if (!products || products.length === 0) {
         gridElement.innerHTML = `<p class="text-slate-500 col-span-full text-center py-10">No products found matching your criteria.</p>`;
         return;
       }

      gridElement.innerHTML = products.map(p => {
           let priceHTML = '';
           let offerBadgeHTML = '';
           let currentPrice = p.price;
           let originalPriceForDisplay = p.originalPrice;

           const liveOffer = findOfferForProduct(p.id);
           if (liveOffer && !p.offer) {
                if (liveOffer.specialPrice) {
                     currentPrice = liveOffer.specialPrice;
                     originalPriceForDisplay = p.price;
                } else if (liveOffer.percentage) {
                     currentPrice = p.price * (1 - liveOffer.percentage / 100);
                     originalPriceForDisplay = p.price;
                }
           } else if (p.offer) {
                 currentPrice = p.price;
                 originalPriceForDisplay = p.originalPrice;
           } else {
                 currentPrice = p.price;
                 originalPriceForDisplay = null;
           }

           if (originalPriceForDisplay && originalPriceForDisplay > currentPrice) {
                priceHTML = `
                     <p class="font-bold text-amber-600 text-lg">Rs. ${currentPrice.toLocaleString('en-US', { minimumFractionDigits: 2 })}</p>
                     <p class="text-sm text-gray-500 line-through">Rs. ${originalPriceForDisplay.toLocaleString('en-US', { minimumFractionDigits: 2 })}</p>
                `;
                if (liveOffer && !p.offer){
                     let offerText = liveOffer.percentage ? `${liveOffer.percentage}% OFF` : 'Offer';
                     offerBadgeHTML = `<span class="absolute top-2 right-2 bg-amber-600 text-white text-xs font-bold px-2 py-1 rounded-md uppercase z-10">${offerText}</span>`;
                } else if (p.offer) {
                     let offerText = p.offer.percentage ? `${p.offer.percentage}% OFF` : 'Offer';
                     offerBadgeHTML = `<span class="absolute top-2 right-2 bg-amber-600 text-white text-xs font-bold px-2 py-1 rounded-md uppercase z-10">${offerText}</span>`;
                }

           } else {
                priceHTML = `<p class="font-bold text-amber-600 text-lg">Rs. ${currentPrice.toLocaleString('en-US', { minimumFractionDigits: 2 })}</p>`;
           }

           const installmentPrice3x = (currentPrice / 3).toLocaleString('en-US', { minimumFractionDigits: 2 });
           const installmentPrice4x = (currentPrice / 4).toLocaleString('en-US', { minimumFractionDigits: 2 });
           const descriptionSnippet = p.description ? p.description.substring(0, 70) + (p.description.length > 70 ? '...' : '') : '';

           return `
           <div class="product-card bg-white rounded-lg relative group">
                ${offerBadgeHTML}
                <div class="product-image-container">
                     <img src="${p.imageUrl || 'https://placehold.co/300x300?text=No+Image'}" alt="${p.name}" class="product-image" loading="lazy">
                     <div class="action-icons">
                         <a href="cart.html" title="Go to Cart"><i class="fas fa-shopping-cart"></i></a>
                         <button class="search-by-category-btn" data-category="${p.category || 'all'}" title="Search by Category"><i class="fas fa-search"></i></button>
                         <button class="compare-btn" title="Compare"><i class="fas fa-exchange-alt"></i></button>
                         <button class="wishlist-btn" data-product-id="${p.id}" title="Add to Wishlist"><i class="fas fa-heart"></i></button>
                     </div>
                </div>
                <div class="product-info-area">
                     <h3 class="product-name font-semibold text-sm text-gray-700">${p.name}</h3>
                     <p class="product-description-snippet">${descriptionSnippet}</p>
                     <div class="price-section">${priceHTML}</div>
                     <div class="installment-info text-xs text-gray-500 mt-1 space-y-1">
                          <p>or 3X <span class="font-semibold text-gray-700">Rs. ${installmentPrice3x}</span> with <span class="font-bold" style="color: #00b8a9;">koko</span> <i class="fas fa-info-circle text-gray-400 text-xs"></i></p>
                          <p>or up to 4X <span class="font-semibold text-gray-700">Rs. ${installmentPrice4x}</span> with <span class="font-bold" style="color: #1ed760;">mintpay</span></p>
                     </div>
                </div>
           </div>`;
      }).join('');
    };

    const renderCategorySidebar = (categories) => {
         if (!categorySidebarList) return;
         let categoryHTML = `<a href="#" class="category-link ${currentCategoryFilter === 'all' ? 'font-bold text-amber-600 bg-amber-100' : ''}" data-category="all">All Products</a>`;
         categoryHTML += categories.map(cat => ` <a href="#" class="category-link flex justify-between items-center ${currentCategoryFilter === cat.name ? 'font-bold text-amber-600 bg-amber-100' : ''}" data-category="${cat.name}"> <span>${cat.name}</span> <i class="fas fa-chevron-right text-xs text-gray-400"></i> </a> `).join('');
         categorySidebarList.innerHTML = categoryHTML;

         if(searchCategoryDropdown) {
              let dropdownHTML = `<option value="all">ALL CATEGORIES</option>`;
              dropdownHTML += categories.map(cat => `<option value="${cat.name}">${cat.name.toUpperCase()}</option>`).join('');
              searchCategoryDropdown.innerHTML = dropdownHTML;
         }
    };


    const renderCategoryExplorer = (categories) => {
         if (!categoryExplorerGrid) return;
         if (categories.length === 0) {
             categoryExplorerGrid.innerHTML = '<p class="text-slate-500 col-span-full text-center py-5">No categories found.</p>';
             return;
         }
         categoryExplorerGrid.innerHTML = categories.map(cat => `
             <a href="#" class="category-explorer-card category-link block bg-white rounded-lg overflow-hidden text-center" data-category="${cat.name}">
                    <img src="${cat.imageUrl || 'https://via.placeholder.com/300x225?text=No+Image'}" alt="${cat.name}" class="w-full h-auto" loading="lazy">
                    <p class="font-semibold text-gray-700 py-3 px-2 text-sm">${cat.name.toUpperCase()}</p>
                </a>
         `).join('');
    };

    const showCategoryDetails = (categoryName) => {
         const category = categoriesCache.find(c => c.name === categoryName);
         if (!category) return;
         mainContentSections.forEach(section => {
             if (section) section.classList.add('hidden');
         });
         searchResultsArea.classList.add('hidden');

         if (categoryDetailTitle) categoryDetailTitle.textContent = category.name;
         if (categoryDetailBanner) categoryDetailBanner.src = category.bannerUrl;
         const categoryProducts = currentProducts.filter(p => p.category === categoryName);
         renderProducts(categoryProducts, 'category-detail-product-grid');
         if (categoryDetailSection) {
             categoryDetailSection.classList.remove('hidden');
             categoryDetailSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
         }
    };

    const hideCategoryDetails = () => {
         if (categoryDetailSection) categoryDetailSection.classList.add('hidden');
         mainContentSections.forEach(section => {
              if (section && section !== searchResultsArea) section.classList.remove('hidden');
         });
         if (exploreCategoriesSection) {
             exploreCategoriesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
         }
    };


    onSnapshot(query(categoriesCol, orderBy("name")), (snapshot) => { 
        categoriesCache = snapshot.docs.map(doc => {
            const data = doc.data();
            // Admin panel eken save karana 'bannerImageUrl' eka gannawa.
            // Eka nathnam, parana data walawath 'imageUrl' thiyenawada balanawa.
            const mainImage = data.bannerImageUrl || data.imageUrl; 
            
            return { 
                id: doc.id,
                name: data.name, 
                // 'Explore Categories' section ekata 'mainImage' eka denawa.
                imageUrl: mainImage || 'https://via.placeholder.com/300x225?text=No+Image', // <-- ME THAMAI WENAS KALE
                // Category details page eke loku banner ekata 'bannerImageUrl' eka denawa.
                bannerUrl: data.bannerImageUrl || 'https://via.placeholder.com/1200x400?text=No+Banner'
            };
        }); 
        renderCategorySidebar(categoriesCache); 
        renderCategoryExplorer(categoriesCache); 
    }, error => console.error("Error fetching categories:", error));
    
    onSnapshot(query(offersCol, orderBy("displayOrder", "asc")), (snapshot) => {
         allActiveOffers.clear();
         snapshot.forEach(doc => { allActiveOffers.set(doc.id, { id: doc.id, ...doc.data() }); });
         // Removed loadHomepagePromotions();
         filterAndSearch();

     }, error => console.error("Error fetching all offers:", error));


    onSnapshot(query(productsCol, orderBy("createdAt", "desc")), (snapshot) => {
         currentProducts = snapshot.docs.map(doc => {
             const p = { id: doc.id, ...doc.data() };
             return { ...p, price: p.price, originalPrice: p.price, offer: null };
         });
         filterAndSearch();
        }, (error) => {
         console.error("Error fetching products: ", error);
         if (productGrid) productGrid.innerHTML = '<p class="text-red-500 col-span-full text-center">Error loading products.</p>';
         if (searchResultsGrid) searchResultsGrid.innerHTML = '<p class="text-red-500 col-span-full text-center">Error loading products.</p>';
        });

    const displaySearchResults = (term, productsToShow, categoryBanner = null, categoryName = null) => {
         mainContentSections.forEach(s => s?.classList.add('hidden'));
         categoryDetailSection.classList.add('hidden');

         if (categoryName) {
             searchResultsTitle.textContent = `Results for "${categoryName}"`;
         } else {
             searchResultsTitle.textContent = `Search Results for "${term}"`;
         }

         if (categoryBanner) {
             searchCategoryBanner.src = categoryBanner;
             searchCategoryBanner.alt = `${categoryName} Banner`;
             searchCategoryBanner.classList.remove('hidden');
         } else {
             searchCategoryBanner.classList.add('hidden');
         }

         renderProducts(productsToShow, 'search-results-grid');
         searchResultsArea.classList.remove('hidden');
         searchResultsArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
    };

    const hideSearchResults = () => {
          searchResultsArea.classList.add('hidden');
          mainContentSections.forEach(s => s?.classList.remove('hidden'));
          loadHomepagePromotions();
    };

    const performSearch = async () => {
         const searchTerm = searchBar.value.trim().toLowerCase();
         const selectedCategory = searchCategoryDropdown.value;

         if (!searchTerm && selectedCategory === 'all') {
               hideSearchResults();
               filterAndSearch();
               return;
         }

         searchResultsGrid.innerHTML = '<p class="col-span-full text-center text-gray-500 py-5">Searching...</p>';
         searchResultsArea.classList.remove('hidden');

         const matchedCategory = categoriesCache.find(cat => cat.name.toLowerCase() === searchTerm);

         if (matchedCategory && selectedCategory === 'all') {
             const productsQuery = query(productsCol, where("category", "==", matchedCategory.name));
             const productsSnapshot = await getDocs(productsQuery);
             const categoryProducts = productsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
             displaySearchResults(searchTerm, categoryProducts, matchedCategory.bannerUrl, matchedCategory.name);

         } else {
             let filtered = currentProducts.filter(p => {
                  const categoryMatch = selectedCategory === 'all' || p.category === selectedCategory;
                  const termMatch = searchTerm === '' ||
                                     (p.name && p.name.toLowerCase().includes(searchTerm)) ||
                                     (p.brand && p.brand.toLowerCase().includes(searchTerm)) ||
                                     (p.category && p.category.toLowerCase().includes(searchTerm));
                  return categoryMatch && termMatch;
             });
             const selectedCatData = selectedCategory !== 'all' ? categoriesCache.find(c => c.name === selectedCategory) : null;
             displaySearchResults(searchTerm || selectedCategory, filtered, selectedCatData?.bannerUrl, selectedCategory !== 'all' ? selectedCategory : null);
         }
    };


    const filterAndSearch = () => {
          const searchTerm = searchBar ? searchBar.value.toLowerCase() : '';
          const selectedDropdownCategory = searchCategoryDropdown ? searchCategoryDropdown.value : 'all';

          renderCategorySidebar(categoriesCache);

          if (trustedBrandsSection) { trustedBrandsSection.querySelectorAll('.brand-tab').forEach(tab => { if (tab.dataset.brand && tab.dataset.brand.toLowerCase() === currentBrandFilter?.toLowerCase()) { tab.classList.add('active'); tab.classList.remove('text-gray-500'); } else { tab.classList.remove('active'); tab.classList.add('text-gray-500'); } }); }

          let title1 = "Featured Products";

          if (currentBrandFilter) {
               title1 = `Products by ${currentBrandFilter}`;
          } else if (currentCategoryFilter !== 'all') {
               title1 = currentCategoryFilter;
          }

          if(productGridTitle) productGridTitle.textContent = title1;

          let filtered = currentProducts.filter(p => {
               const sidebarCategoryMatch = currentCategoryFilter === 'all' || p.category === currentCategoryFilter;
               const brandMatch = !currentBrandFilter || (p.brand && p.brand.toLowerCase() === currentBrandFilter.toLowerCase());
               return sidebarCategoryMatch && brandMatch;
          });

          renderProducts(filtered.slice(0, 12), 'product-grid');

          searchResultsArea.classList.add('hidden');
          mainContentSections.forEach(s => s?.classList.remove('hidden'));
          categoryDetailSection.classList.add('hidden');
     };

    if(searchBar) searchBar.addEventListener('keypress', (e) => {
         if (e.key === 'Enter') {
             performSearch();
         }
    });
    if(searchIconBtn) searchIconBtn.addEventListener('click', performSearch);
    if(searchCategoryDropdown) searchCategoryDropdown.addEventListener('change', performSearch);


    if(categorySidebarList) {
         categorySidebarList.addEventListener('click', (e) => {
              const link = e.target.closest('.category-link');
              if (link) {
                   e.preventDefault();
                   currentCategoryFilter = link.dataset.category;
                   currentBrandFilter = null;
                   searchBar.value = '';
                   searchCategoryDropdown.value = 'all';
                   hideSearchResults();
                   filterAndSearch();
              }
         });
      }
    const categoryToggleBtn = document.getElementById('category-toggle-btn'); if(categoryToggleBtn && categorySidebarList) { categoryToggleBtn.addEventListener('click', () => { categorySidebarList.classList.toggle('hidden'); categorySidebarList.classList.toggle('md:block'); }); if (window.innerWidth < 768) { categorySidebarList.classList.add('hidden'); } else { categorySidebarList.classList.add('md:block'); } }

    if (trustedBrandsSection) {
         trustedBrandsSection.addEventListener('click', (e) => {
              const tab = e.target.closest('.brand-tab');
              if (tab) {
                   currentBrandFilter = tab.dataset.brand;
                   currentCategoryFilter = 'all';
                   searchBar.value = '';
                   searchCategoryDropdown.value = 'all';
                   hideSearchResults();
                   filterAndSearch();
              }
         });
    }

    if (categoryExplorerGrid) {
         categoryExplorerGrid.addEventListener('click', (e) => {
              const link = e.target.closest('.category-link');
              if (link) {
                   e.preventDefault();
                   const categoryName = link.dataset.category;
                   showCategoryDetails(categoryName);
              }
         });
    }

    if (backToCategoriesBtn) {
         backToCategoriesBtn.addEventListener('click', (e) => {
              e.preventDefault();
              hideCategoryDetails();
              filterAndSearch();
         });
    }


    document.addEventListener('click', async (e) => {

       if (e.target.closest('.wishlist-btn')) {
           const productId = e.target.closest('.wishlist-btn').dataset.productId;
           if (productId) {
                addToWishlist(productId);
           }
           return;
       }

       if (e.target.closest('.search-by-category-btn')) {
           const category = e.target.closest('.search-by-category-btn').dataset.category;
           if (category && searchBar) {
                searchBar.value = category;
                searchCategoryDropdown.value = 'all';
                performSearch();
           }
           return;
       }

       const productCardLink = e.target.closest('.product-card a:not(.action-icons a)');
       const productCardDiv = e.target.closest('.product-card');

       if (productCardDiv && !e.target.closest('.action-icons button, .action-icons a')) {
            const buttonWithId = productCardDiv.querySelector('[data-product-id]');
            if (buttonWithId) {
                 const productId = buttonWithId.dataset.productId;
                 window.location.href = `product.html?id=${productId}`;
            }
            return;
        }


       if (e.target.closest('#tracking-login-btn')) {
           e.preventDefault();
           if(trackingModal) trackingModal.classList.add('hidden');
           openModal(true);
           return;
       }
    });

    if (logoBtn) {
         logoBtn.addEventListener('click', (e) => {
               e.preventDefault();
               searchBar.value = '';
               searchCategoryDropdown.value = 'all';
               currentCategoryFilter = 'all';
               currentBrandFilter = null;
               hideSearchResults();
               hideCategoryDetails();
               filterAndSearch();
               window.scrollTo({ top: 0, behavior: 'smooth' });
         });
    }

    async function loadHomepagePromotions() {
         if (!promoSectionsContainer) {
             console.error('Cannot find element with ID "promo-sections-container"');
             return;
         }

         promoSectionsContainer.innerHTML = '<p class="text-center text-gray-500 py-10">Loading promotions...</p>';

         try {
             const offersQuery = query(
                 collection(db, "offers"),
                 orderBy("displayOrder", "asc")
             );

             const offersSnapshot = await getDocs(offersQuery);
             const bannerOffers = offersSnapshot.docs.filter(doc => doc.data().bannerImageUrl);

             if (bannerOffers.length === 0) {
                 promoSectionsContainer.innerHTML = "";
                 return;
             }

             promoSectionsContainer.innerHTML = '';

             for (const offerDoc of bannerOffers) {
                  const offer = offerDoc.data();
                  let productsHtml = '';

                  if (offer.productIds && offer.productIds.length > 0) {
                       const productPromises = offer.productIds.map(productId => {
                           try {
                                return getDoc(doc(db, "products", productId));
                           } catch (prodError) {
                                console.warn(`Could not fetch product ${productId} for offer ${offer.name}:`, prodError);
                                return Promise.resolve(null);
                           }
                       });

                       const productDocsResults = await Promise.allSettled(productPromises);

                       productsHtml = productDocsResults.map(result => {
                            if (result.status === 'fulfilled' && result.value && result.value.exists()) {
                                 const productDoc = result.value;
                                 const product = productDoc.data();
                                 const productId = productDoc.id;

                                 let priceHTML = '';
                                 let offerBadgeHTML = '';
                                 let currentPrice = product.price;
                                 let originalPriceForDisplay = null;

                                 if (offer.specialPrice && offer.productIds.includes(productId)) {
                                      currentPrice = offer.specialPrice;
                                      originalPriceForDisplay = product.price;
                                 } else if (offer.percentage && offer.productIds.includes(productId)) {
                                      currentPrice = product.price * (1 - offer.percentage / 100);
                                      originalPriceForDisplay = product.price;
                                 }

                                 if (originalPriceForDisplay && originalPriceForDisplay > currentPrice) {
                                      priceHTML = `
                                          <p class="font-bold text-amber-600 text-lg">Rs. ${currentPrice.toLocaleString('en-US', { minimumFractionDigits: 2 })}</p>
                                          <p class="text-sm text-gray-500 line-through">Rs. ${originalPriceForDisplay.toLocaleString('en-US', { minimumFractionDigits: 2 })}</p>
                                      `;
                                       let offerText = offer.percentage ? `${offer.percentage}% OFF` : 'Offer';
                                       offerBadgeHTML = `<span class="absolute top-2 right-2 bg-amber-600 text-white text-xs font-bold px-2 py-1 rounded-md uppercase z-10">${offerText}</span>`;

                                 } else {
                                      priceHTML = `<p class="font-bold text-amber-600 text-lg">Rs. ${currentPrice.toLocaleString('en-US', { minimumFractionDigits: 2 })}</p>`;
                                 }

                                 const installmentPrice3x = (currentPrice / 3).toLocaleString('en-US', { minimumFractionDigits: 2 });
                                 const installmentPrice4x = (currentPrice / 4).toLocaleString('en-US', { minimumFractionDigits: 2 });
                                 const descriptionSnippet = product.description ? product.description.substring(0, 70) + (product.description.length > 70 ? '...' : '') : '';

                                 return `
                                      <div class="product-card bg-white rounded-lg relative group">
                                           ${offerBadgeHTML}
                                           <div class="product-image-container">
                                                <img src="${product.imageUrl || 'https://placehold.co/300x300?text=No+Image'}" alt="${product.name}" class="product-image" loading="lazy">
                                                <div class="action-icons">
                                                     <a href="cart.html" title="Go to Cart"><i class="fas fa-shopping-cart"></i></a>
                                                     <button class="search-by-category-btn" data-category="${product.category || 'all'}" title="Search by Category"><i class="fas fa-search"></i></button>
                                                     <button class="compare-btn" title="Compare"><i class="fas fa-exchange-alt"></i></button>
                                                     <button class="wishlist-btn" data-product-id="${productId}" title="Add to Wishlist"><i class="fas fa-heart"></i></button>
                                                </div>
                                           </div>
                                           <div class="product-info-area">
                                                <h3 class="product-name font-semibold text-sm text-gray-700">${product.name}</h3>
                                                <p class="product-description-snippet">${descriptionSnippet}</p>
                                                <div class="price-section">
                                                     ${priceHTML}
                                                </div>
                                                <div class="installment-info text-xs text-gray-500 mt-1 space-y-1">
                                                     <p>or 3X <span class="font-semibold text-gray-700">Rs. ${installmentPrice3x}</span> with <span class="font-bold" style="color: #00b8a9;">koko</span> <i class="fas fa-info-circle text-gray-400 text-xs"></i></p>
                                                     <p>or up to 4X <span class="font-semibold text-gray-700">Rs. ${installmentPrice4x}</span> with <span class="font-bold" style="color: #1ed760;">mintpay</span></p>
                                                </div>
                                           </div>
                                      </div>
                                      `;
                            } else if (result.status === 'rejected') {
                                 console.warn(`Failed to fetch product details for offer ${offer.name}. Reason:`, result.reason);
                                 return '';
                            } else {
                                 return '';
                            }
                       }).join('');
                  }

                  const sectionHtml = `
                       <section class="homepage-promo-section">
                            <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center md:text-left">${offer.name}</h2>
                            <div class="banner-image mb-6 rounded-lg overflow-hidden shadow-lg border border-gray-200">
                                 <img src="${offer.bannerImageUrl}" alt="${offer.name} Banner" class="w-full h-auto object-cover" loading="lazy">
                            </div>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                                 ${productsHtml || '<p class="col-span-full text-center text-gray-500 py-5">No products currently assigned to this promotion.</p>'}
                            </div>
                       </section>
                  `;

                  promoSectionsContainer.innerHTML += sectionHtml;
             }

         } catch (error) {
             console.error("Error loading homepage promotions:", error);
             promoSectionsContainer.innerHTML = '<p class="text-center text-red-500 py-10">Error loading promotions. Please try again later.</p>';
         }
    }

    updateCartCountBadge();
    updateWishlistCountBadge();
    renderCartModal();
    loadHomepagePromotions();

</script>

</body>
</html>
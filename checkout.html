<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="icon.png">
    <title>TPA - Checkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-bg { background-color: rgba(0,0,0,0.5); }
        .tab-button.active { border-color: #eab308; color: #eab308; } /* Amber */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .pop { animation: pop 0.2s ease-out; }
        /* --- AMBER COLOR SCHEME --- */
        .header-top-bar { background-color: #eab308; } /* Amber */
        .main-accent-color { color: #eab308; } /* Amber */
        .main-accent-color-hover:hover { color: #d97706; } /* Darker Amber */
        .main-accent-bg { background-color: #eab308; } /* Amber */
        .main-accent-bg-hover:hover { background-color: #d97706; } /* Darker Amber */
        .main-accent-border { border-color: #eab308; } /* Amber */
        .main-nav { background-color: #f3f4f6; border-bottom: 1px solid #e5e7eb; } /* From index */

        .footer-bottom .fa-cc-visa { color: #1A1F71; }
        .footer-bottom .fa-cc-amex { color: #007BC1; }
        .footer-bottom .fa-cc-paypal { color: #003087; }
        .footer-bottom .fa-cc-mastercard { color: #EB001B; }
        .footer-bottom .fa-cc-discover { color: #FF6600; }
        .fixed-chat-button {
            position: fixed; bottom: 20px; right: 20px; z-index: 1000;
            background-color: #eab308; color: white; /* Amber */
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); cursor: pointer;
            transition: transform 0.2s ease;
        }
        .fixed-chat-button:hover { transform: scale(1.1); }
        .fixed-chat-button i { font-size: 28px; }
        #cart-drawer {
            transform: translateX(100%); transition: transform 0.3s ease-in-out;
        }
        #cart-modal-bg { opacity: 0; transition: opacity 0.3s ease-in-out; }
        #cart-modal:not(.hidden) #cart-drawer { transform: translateX(0); }
        #cart-modal:not(.hidden) #cart-modal-bg { opacity: 1; }
        /* Footer Styles from index */
        .site-footer { background-color: #f8f8f8; color: #555; font-size: 0.875rem; }
        .site-footer h4 { font-weight: 600; color: #333; margin-bottom: 1rem; text-transform: uppercase; }
        .site-footer a { color: #555; transition: color 0.2s ease; }
        .site-footer a:hover { color: #d97706; } /* Amber Hover */
        .footer-bottom { background-color: #eee; color: #666; font-size: 0.75rem; }
        /* Checkout Input styles */
        #checkout-form input[type="text"],
        #checkout-form input[type="email"],
        #checkout-form input[type="tel"],
        #checkout-form select,
        #checkout-form textarea {
             width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;
             transition: border-color 0.2s, box-shadow 0.2s;
        }
        #checkout-form input:focus,
        #checkout-form select:focus,
        #checkout-form textarea:focus {
            outline: none; border-color: #eab308;
            box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.3);
        }
        /* Payment Radio Style */
        .payment-label {
            border: 2px solid #e5e7eb;
            transition: border-color 0.2s;
        }
        input[name="payment-method"]:checked + .payment-label {
            border-color: #eab308; /* Amber */
            background-color: #fffbeb; /* Amber 50 */
        }
        /* Loader for success modals */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #eab308; /* Amber */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50">

    <div id="auth-modal" class="fixed inset-0 modal-bg z-50 flex items-center justify-center hidden"> <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4"> <div class="p-4 border-b"> <div class="flex justify-between items-center"> <h2 class="text-xl font-bold text-slate-700">Welcome!</h2> <button id="close-modal-btn" class="text-slate-500 hover:text-slate-800 text-3xl leading-none">&times;</button> </div> </div> <div class="p-2 bg-slate-100 flex gap-2"> <button id="login-tab-btn" class="tab-button active flex-1 bg-white p-2 rounded-md font-semibold border-b-2 main-accent-border main-accent-color">Login</button> <button id="signup-tab-btn" class="tab-button flex-1 bg-white p-2 rounded-md font-semibold text-slate-500 border-b-2 border-transparent">Sign Up</button> </div> <div class="p-6" style="max-height: 70vh; overflow-y: auto;"> <form id="login-form" class="space-y-4"> <input type="email" id="login-email" placeholder="Email" required class="w-full p-3 border rounded-md"> <input type="password" id="login-password" placeholder="Password" required class="w-full p-3 border rounded-md"> <button type="submit" class="w-full main-accent-bg text-white p-3 rounded-md main-accent-bg-hover">Login</button> <p id="login-error" class="text-red-500 text-sm text-center"></p> </form> <form id="signup-form" class="space-y-4 hidden"> <input type="text" id="signup-name" placeholder="Full Name" required class="w-full p-3 border rounded-md"> <input type="email" id="signup-email" placeholder="Email" required class="w-full p-3 border rounded-md"> <input type="password" id="signup-password" placeholder="Password" required class="w-full p-3 border rounded-md"> <input type="tel" id="signup-phone" placeholder="Phone Number" required class="w-full p-3 border rounded-md"> <input type="text" id="signup-address" placeholder="Address" required class="w-full p-3 border rounded-md"> <div class="grid grid-cols-2 gap-4"> <input type="text" id="signup-city" placeholder="City" required class="w-full p-3 border rounded-md"> <input type="text" id="signup-district" placeholder="District" required class="w-full p-3 border rounded-md"> </div> <input type="text" id="signup-postal-code" placeholder="Postal Code" required class="w-full p-3 border rounded-md"> <button type="submit" class="w-full main-accent-bg text-white p-3 rounded-md main-accent-bg-hover">Create Account</button> <p id="signup-error" class="text-red-500 text-sm text-center"></p> </form> </div> </div> </div>

     <div id="cart-modal" class="fixed inset-0 z-50 hidden">
         <div id="cart-modal-bg" class="fixed inset-0 modal-bg"></div>
         <div id="cart-drawer" class="fixed top-0 right-0 h-full bg-white shadow-xl w-full max-w-md flex flex-col">
             <div class="p-4 flex justify-between items-center border-b flex-shrink-0">
                 <h2 class="text-xl font-semibold text-slate-800">Shopping cart</h2>
                 <button id="close-cart-btn" class="text-slate-500 hover:text-slate-800 text-sm flex items-center gap-1">
                     <i class="fas fa-times"></i> Close
                 </button>
             </div>
             <div class="flex-grow p-6 overflow-y-auto">
                 <div id="cart-items-container" class="divide-y divide-slate-100">
                     <p class="text-slate-500 py-6 text-center">Your cart is empty.</p>
                 </div>
             </div>
             <div class="p-6 border-t bg-slate-50 flex-shrink-0">
                 <div class="flex justify-between items-center mb-2">
                     <span class="text-lg font-medium text-slate-600">Subtotal:</span>
                     <span id="cart-total" class="text-xl font-bold main-accent-color">Rs. 0.00</span>
                 </div>
                 <p class="text-sm text-center text-slate-500 mb-2">Shipping & taxes calculated at checkout.</p>
                 <div class="flex flex-col gap-3 mt-4">
                     <a href="cart.html" class="w-full text-center bg-white border-2 main-accent-border main-accent-color p-3 rounded-lg hover:bg-amber-50 font-bold text-base">
                         VIEW CART
                     </a>
                     <a href="checkout.html" id="checkout-btn-modal" class="w-full text-center main-accent-bg text-white p-3 rounded-lg main-accent-bg-hover font-bold text-base">
                         CHECKOUT
                     </a>
                 </div>
             </div>
         </div>
     </div>

     <div id="tracking-modal" class="fixed inset-0 modal-bg z-50 flex items-center justify-center hidden"> <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4" style="max-height: 90vh;"> <div class="p-6 flex justify-between items-center border-b"> <h2 class="text-3xl font-bold text-slate-800">My Orders</h2> <button id="close-tracking-btn" class="text-slate-500 hover:text-slate-800 text-3xl leading-none">&times;</button> </div> <div id="tracking-items-container" class="p-6 flex flex-col" style="max-height: calc(90vh - 100px); overflow-y: auto;"> <p class="text-slate-500 text-center">Loading your orders...</p> </div> </div> </div>
     
     <div id="cod-success-modal" class="fixed inset-0 modal-bg z-[60] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm text-center p-6">
            <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Your order is placed!</h2>
            <p class="text-gray-600 mb-4">Thank you for your purchase.</p>
            <p class="text-sm text-gray-500">Your Order ID is:</p>
            <div class="flex items-center justify-center gap-2 my-2">
                <span id="success-order-id" class="text-lg font-bold text-gray-700 bg-gray-100 px-3 py-1 rounded">...</span>
                <button id="copy-order-id-btn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm font-semibold">Copy</button>
            </div>
            <div class="flex flex-col gap-3 mt-6">
                <button id="track-order-btn" class="w-full main-accent-bg text-white p-3 rounded-md main-accent-bg-hover font-bold">Track Your Order</button>
                <a href="index.html" class="w-full bg-slate-100 text-slate-700 p-3 rounded-md hover:bg-slate-200 font-bold text-center">Go to Homepage</a>
            </div>
        </div>
    </div>
    
    <div id="call-success-modal" class="fixed inset-0 modal-bg z-[60] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm text-center p-6">
            <i class="fas fa-phone-volume text-6xl text-amber-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Thank You!</h2>
            <p class="text-gray-600 mb-4">Your order is received.</p>
            <div class="loader my-4"></div>
            <p class="text-lg font-semibold text-gray-700">We will call you shortly to confirm the order.</p>
            <div class="flex flex-col gap-3 mt-6">
                <a href="index.html" class="w-full main-accent-bg text-white p-3 rounded-md main-accent-bg-hover font-bold text-center">Go to Homepage</a>
            </div>
        </div>
    </div>


     <header class="sticky top-0 z-40 bg-white shadow-md">
         <div class="header-top-bar text-white text-xs py-1"> <div class="container mx-auto px-4 flex justify-between items-center"> <span>Your Ultimate Destination</span> <div class="flex items-center space-x-4"> <a href="#" class="hover:text-gray-300"><i class="fab fa-facebook-f"></i></a> <a href="#" class="hover:text-gray-300"><i class="fab fa-instagram"></i></a> <a href="#" class="hover:text-gray-300"><i class="fab fa-whatsapp"></i></a> <span class="border-l border-amber-400 h-4"></span> <a href="#" class="hover:underline">NEWSLETTER</a> <a href="#" class="hover:underline">CONTACT US</a> <a href="#" class="hover:underline">FAQS</a> </div> </div> </div>
         <div class="py-4 border-b"> <div class="container mx-auto px-4 flex justify-between items-center gap-6"> <a href="index.html" id="logo-btn" class="flex-shrink-0">
             <img src="LOGO.png" alt="TPA - The Phone Arcade" class="h-10 md:h-12">
             </a> <div class="flex-grow flex border border-gray-300 rounded-md overflow-hidden"> <input type="text" id="search-bar" placeholder="Search for products" class="w-full px-4 py-2 focus:outline-none text-sm">
             <select id="search-category-dropdown" class="border-l border-gray-300 px-2 text-sm text-gray-600 focus:outline-none bg-gray-50 hidden md:block">
                 <option value="all">ALL CATEGORIES</option>
             </select>
             <button id="search-icon-btn" class="bg-gray-100 px-4 text-gray-600 hover:bg-gray-200"> <i class="fas fa-search"></i> </button> </div> <div class="flex items-center space-x-3 md:space-x-4 text-gray-700"> <div id="auth-links" class="text-sm hidden md:block"> <button id="login-btn-nav" class="hover:main-accent-color">LOGIN</button> / <button id="signup-btn-nav" class="hover:main-accent-color">REGISTER</button> </div> <div id="user-info" class="hidden items-center space-x-2 text-sm"> <i class="fas fa-user text-xl text-gray-500"></i> <span id="user-email" class="hidden lg:inline"></span> <button id="logout-btn-nav" class="hover:main-accent-color ml-2">(Logout)</button> </div> <span class="border-l h-5 self-center hidden md:block"></span> <a href="#" title="Wishlist" class="relative hover:main-accent-color"> <i class="fas fa-heart text-xl"></i> <span class="absolute -top-1 -right-1 main-accent-bg text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">0</span> </a> <a href="#" title="Compare" class="relative hover:main-accent-color hidden md:block"> <i class="fas fa-exchange-alt text-xl"></i> <span class="absolute -top-1 -right-1 main-accent-bg text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">0</span> </a> <a href="cart.html" id="cart-icon" title="Cart" class="relative hover:main-accent-color flex items-center"> <i class="fas fa-shopping-bag text-xl"></i> <span id="cart-count-badge" class="absolute -top-1 -right-2 main-accent-bg text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">0</span> <span class="ml-2 text-sm font-semibold hidden md:inline">Rs.0.00</span> </a> <button id="tracking-icon-btn" title="Track My Orders" class="relative hover:main-accent-color"> <i class="fas fa-clipboard-list text-xl"></i> </button> </div> </div> </div>
         <nav class="main-nav hidden md:block"> <div class="container mx-auto px-4 flex justify-between items-center h-12"> <div class="flex space-x-6 text-sm font-medium"> <a href="index.html" class="main-accent-color hover:text-gray-900">HOME</a> <a href="index.html?category=all" class="text-gray-700 hover:main-accent-color">SHOP</a> <a href="#" class="text-gray-700 hover:main-accent-color">ABOUT US</a> <a href="#" class="text-gray-700 hover:main-accent-color">CONTACT US</a> <a href="#" class="text-gray-700 hover:main-accent-color">STORE</a> </div> <a href="#" class="main-accent-color font-semibold text-sm flex items-center gap-1 hover:text-gray-900"> <i class="fas fa-heart text-xs"></i> SPECIAL OFFERS </a> </div> </nav>
     </header>

    <main>
        <div id="checkout-page" class="container mx-auto p-6 mt-6">
            <h1 class="text-3xl font-bold text-slate-800 mb-6">Checkout</h1>
            <div class="flex flex-col lg:flex-row gap-8">
    
                <div class="w-full lg:w-3/5">
                    <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                        <form id="checkout-form" class="space-y-4">
                            <h2 class="text-2xl font-semibold mb-4">Billing Details</h2>
    
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="first-name" class="block text-sm font-medium text-slate-700">First name</label>
                                    <input type="text" id="first-name" name="first-name" required>
                                </div>
                                <div>
                                    <label for="last-name" class="block text-sm font-medium text-slate-700">Last name</label>
                                    <input type="text" id="last-name" name="last-name" required>
                                </div>
                            </div>
    
                            <div>
                                <label for="email" class="block text-sm font-medium text-slate-700">Email</label>
                                <input type="email" id="email" name="email" required>
                            </div>
    
                            <div>
                                <label for="mobile" class="block text-sm font-medium text-slate-700">Mobile</label>
                                <input type="tel" id="mobile" name="mobile" required>
                            </div>
    
                            <div>
                                <label for="address" class="block text-sm font-medium text-slate-700">Home No, Street</label>
                                <input type="text" id="address" name="address" required>
                            </div>
    
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="city" class="block text-sm font-medium text-slate-700">City</label>
                                    <input type="text" id="city" name="city" required>
                                </div>
                                <div>
                                    <label for="district" class="block text-sm font-medium text-slate-700">District</label>
                                    <input type="text" id="district" name="district" required>
                                </div>
                            </div>
                             
                             <div>
                                <label for="postal-code" class="block text-sm font-medium text-slate-700">Postal Code (Optional)</label>
                                <input type="text" id="postal-code" name="postalCode">
                            </div>
                            
                            <div>
                                <label for="order-notes" class="block text-sm font-medium text-slate-700">Order notes (Optional)</label>
                                <textarea id="order-notes" name="orderNotes" rows="3" class="mt-1 w-full p-3 border rounded-md" placeholder="Notes about your order, e.g. special notes for delivery."></textarea>
                            </div>

                        </form>
                    </div>
                </div>
    
                <div class="w-full lg:w-2/5">
                    <div id="order-summary" class="bg-white rounded-lg shadow-md p-6 sticky top-24 space-y-6 border border-gray-200">
                        <h2 class="text-2xl font-semibold mb-4 border-b pb-4">Your Order</h2>
                        
                        <div id="checkout-items-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                            <p class="text-slate-500">Loading cart...</p>
                        </div>
    
                        <div class="space-y-3 pt-4 border-t">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Total Amount</span>
                                <span id="checkout-total" class="font-semibold text-gray-800">Rs. 0.00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Discount Amount</span>
                                <span id="checkout-discount" class="font-semibold text-red-600">Rs. 0.00</span>
                            </div>
                            <hr class="my-2">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-medium text-gray-700">Payable Amount</span>
                                <span id="checkout-payable" class="text-xl font-bold main-accent-color">Rs. 0.00</span>
                            </div>
                        </div>
                        
                        <button id="proceed-to-pay-btn" class="w-full main-accent-bg text-white p-3 rounded-md hover:bg-amber-700 font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            Proceed to Payment
                        </button>
                    </div>
                </div>
    
            </div>
        </div>
    
        <div id="payment-page" class="container mx-auto p-6 hidden mt-6">
            <h1 class="text-3xl font-bold text-slate-800 mb-6">Payment Method</h1>
            <div class="max-w-2xl mx-auto">
                <div class="bg-white rounded-lg shadow-md border border-gray-200">
                    <div class="p-6">
                        <h2 class="text-xl font-semibold mb-4 text-slate-700">Select a payment method</h2>
                        
                        <div class="space-y-4">
                            <input type="radio" id="payment-cod" name="payment-method" value="cod" class="hidden peer">
                            <label for="payment-cod" class="payment-label flex items-center justify-between p-4 rounded-lg cursor-pointer">
                                <div class="flex items-center gap-4">
                                    <i class="fas fa-money-bill-wave text-3xl main-accent-color"></i>
                                    <div>
                                        <span class="font-bold text-lg text-slate-800">Cash on Delivery</span>
                                        <p class="text-sm text-slate-500">Pay with cash when your order is delivered.</p>
                                    </div>
                                </div>
                                <i class="fas fa-check-circle text-amber-500 opacity-0 peer-checked:opacity-100 transition-opacity"></i>
                            </label>
    
                            <input type="radio" id="payment-call" name="payment-method" value="call" class="hidden peer">
                            <label for="payment-call" class="payment-label flex items-center justify-between p-4 rounded-lg cursor-pointer">
                                <div class="flex items-center gap-4">
                                    <i class="fas fa-phone-volume text-3xl main-accent-color"></i>
                                    <div>
                                        <span class="font-bold text-lg text-slate-800">Call us and get order</span>
                                        <p class="text-sm text-slate-500">Our team will call you to confirm the order.</p>
                                    </div>
                                </div>
                                <i class="fas fa-check-circle text-amber-500 opacity-0 peer-checked:opacity-100 transition-opacity"></i>
                            </label>
                        </div>

                    </div>
    
                    <div class="p-6 border-t bg-slate-50 rounded-b-lg space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-medium text-slate-700">Total to Pay:</span>
                            <span id="payment-payable-amount" class="text-2xl font-bold main-accent-color">Rs. 0.00</span>
                        </div>
                        <button id="confirm-order-btn" class="w-full main-accent-bg text-white p-4 rounded-lg main-accent-bg-hover font-bold text-lg">
                            Confirm Order
                        </button>
                        <button id="back-to-checkout-btn" class="w-full bg-white text-slate-700 p-3 rounded-lg hover:bg-slate-100 font-semibold border shadow-sm">
                            &larr; Back to Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>


   <footer class="site-footer border-t pt-10 mt-10">
          <div class="container mx-auto px-4 pb-10">
               <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div class="space-y-4">
                         <img src="LOGO.png" alt="TPA - The Phone Arcade" class="h-10 mb-4">
                         <p>High-quality electronics, essentials & appliances are now at your fingertips. Confirm your order now !</p>
                         <p><i class="fas fa-map-marker-alt mr-2 text-amber-700"></i> 890/a Main Street, Kaduruwela, Polonnaruwa</p>
                         <p><i class="fas fa-phone-alt mr-2 text-amber-700"></i> Phone: 077 754 9654 / 027 222 4470</p>
                         <p><i class="fas fa-envelope mr-2 text-amber-700"></i> Email: info@thephonearcade.com</p>
                    </div>
                    <div>
                         <h4>Quick Links</h4>
                         <ul class="space-y-2">
                              <li><a href="index.html">Home</a></li>
                              <li><a href="shop.html">Shop</a></li>
                              <li><a href="about.html">About Us</a></li>
                              <li><a href="contact.html">Contact Us</a></li>
                              <li><a href="#">Special Offers</a></li>
                         </ul>
                    </div>
                    <div>
                         <h4>Useful Links</h4>
                         <ul class="space-y-2">
                              <li><a href="#">Privacy Policy</a></li>
                              <li><a href="#">Returns</a></li>
                              <li><a href="#">Terms & Conditions</a></li>
                              <li><a href="#">Contact Us</a></li>
                              <li><a href="#">Latest News</a></li>
                              <li><a href="#">Our Sitemap</a></li>
                         </ul>
                    </div>
                    <div>
                         <h4>My Account</h4>
                         <ul class="space-y-2">
                              <li><a href="profile.html">My Profile</a></li>
                              <li><a href="cart.html">View Cart</a></li>
                              <li><a href="#" id="footer-orders-link">Track My Orders</a></li>
                              <li><a href="wishlist.html">My Wishlist</a></li>
                         </ul>
                    </div>
               </div>
          </div>
          <div class="footer-bottom py-4 px-4">
               <div class="container mx-auto flex flex-col md:flex-row justify-between items-center text-center md:text-left">
                    <span>TPA Â© 2025 CREATED BY <a href="https://pixora.com" target="_blank" rel="noopener noreferrer" class="font-semibold hover:text-amber-700">PIXORA IT SOLUTIONS</a></span>
                    <div class="flex space-x-2 mt-4 md:mt-0">
                         <i class="fab fa-cc-visa text-2xl"></i>
                         <i class="fab fa-cc-amex text-2xl"></i>
                         <i class="fab fa-cc-paypal text-2xl"></i>
                         <i class="fab fa-cc-mastercard text-2xl"></i>
                         <i class="fab fa-cc-discover text-2xl"></i>
                         </div>
               </div>
          </div>
     </footer>

     <a href="https://wa.me/94777349654?text=Hello%20TPA%2C%20I'd%20like%20to%20ask%20a%20question."
        class="fixed-chat-button"
        aria-label="Chat on WhatsApp"
        target="_blank"
        rel="noopener noreferrer">
        <i class="fab fa-whatsapp"></i> </a>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, setDoc, doc, limit, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAtvnbedBpCiRe_ZyfoB-TacrboEMgft5Y", authDomain: "mobile-shop-1c315.firebaseapp.com", projectId: "mobile-shop-1c315", storageBucket: "mobile-shop-1c315.firebasestorage.app", messagingSenderId: "689278786227", appId: "1:689278786227:web:ee06565e4a230381bf6ec6", measurementId: "G-MLDEWBBEMV"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const categoriesCol = collection(db, 'categories');
    const usersCol = collection(db, 'users');
    const ordersCol = collection(db, 'orders');

    const authModal = document.getElementById('auth-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const loginBtnNav = document.getElementById('login-btn-nav');
    const signupBtnNav = document.getElementById('signup-btn-nav');
    const logoutBtnNav = document.getElementById('logout-btn-nav');
    const loginTab = document.getElementById('login-tab-btn');
    const signupTab = document.getElementById('signup-tab-btn');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const authLinks = document.getElementById('auth-links');
    const userInfo = document.getElementById('user-info');
    const userEmailSpan = document.getElementById('user-email');
    const cartCountBadge = document.getElementById('cart-count-badge');
    const cartIcon = document.getElementById('cart-icon');
    const cartModal = document.getElementById('cart-modal');
    const cartModalBg = document.getElementById('cart-modal-bg');
    const closeCartBtn = document.getElementById('close-cart-btn');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartTotalEl = document.getElementById('cart-total');
    const trackingModal = document.getElementById('tracking-modal');
    const closeTrackingBtn = document.getElementById('close-tracking-btn');
    const trackingIconBtn = document.getElementById('tracking-icon-btn');
    const trackingItemsContainer = document.getElementById('tracking-items-container');
    const logoBtn = document.getElementById('logo-btn');
    const searchBar = document.getElementById('search-bar');
    const searchCategoryDropdown = document.getElementById('search-category-dropdown');
    const searchIconBtn = document.getElementById('search-icon-btn');

    const checkoutPage = document.getElementById('checkout-page');
    const paymentPage = document.getElementById('payment-page');
    const checkoutItemsList = document.getElementById('checkout-items-list');
    const checkoutTotalEl = document.getElementById('checkout-total');
    const checkoutDiscountEl = document.getElementById('checkout-discount');
    const checkoutPayableEl = document.getElementById('checkout-payable');
    const paymentPayableAmountEl = document.getElementById('payment-payable-amount');
    
    const paymentCodRadio = document.getElementById('payment-cod');
    const paymentCallRadio = document.getElementById('payment-call');
    
    const callSuccessModal = document.getElementById('call-success-modal');
    const codSuccessModal = document.getElementById('cod-success-modal');
    const successOrderId = document.getElementById('success-order-id');
    const copyOrderIdBtn = document.getElementById('copy-order-id-btn');
    const trackOrderBtn = document.getElementById('track-order-btn');

    let currentOrderDetails = {};
    let categoriesCache = [];
    let currentUserDetails = null;

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            if(authLinks) { authLinks.classList.add('hidden'); authLinks.classList.remove('md:block'); }
            if(userInfo) { userInfo.classList.remove('hidden'); userInfo.classList.add('flex'); }
            try {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    currentUserDetails = userDoc.data();
                    if (userDoc.data().role === "admin") {
                        if(userEmailSpan) userEmailSpan.textContent = `${user.email} (Admin)`;
                    } else {
                        if(userEmailSpan) userEmailSpan.textContent = user.email;
                    }
                    if(checkoutPage && !checkoutPage.classList.contains('hidden')){
                        prefillCheckoutForm(currentUserDetails);
                    }
                } else {
                     currentUserDetails = { email: user.email, name: user.email, phone: '', address: '', city: '', district: '', postalCode: '' };
                     if(checkoutPage && !checkoutPage.classList.contains('hidden')){
                        prefillCheckoutForm(currentUserDetails);
                    }
                }
            } catch (error) {
                console.error("Error fetching user role: ", error);
                if(userEmailSpan) userEmailSpan.textContent = user.email;
                currentUserDetails = { email: user.email, name: user.email, phone: '', address: '', city: '', district: '', postalCode: '' };
            }
            if(authModal) authModal.classList.add('hidden');
        } else {
            if(authLinks) { authLinks.classList.remove('hidden', 'md:block'); authLinks.classList.add('md:block'); }
            if(userInfo) { userInfo.classList.add('hidden'); userInfo.classList.remove('flex'); }
            if(userEmailSpan) userEmailSpan.textContent = '';
            currentUserDetails = null;
        }
    });

    const openModal = (isLogin = true) => { if(authModal) authModal.classList.remove('hidden'); if(isLogin){ if(loginTab) loginTab.click(); } else { if(signupTab) signupTab.click(); } }; if(loginBtnNav) loginBtnNav.addEventListener('click', () => openModal(true)); if(signupBtnNav) signupBtnNav.addEventListener('click', () => openModal(false)); if(closeModalBtn) closeModalBtn.addEventListener('click', () => {if(authModal) authModal.classList.add('hidden');}); if(loginTab) loginTab.addEventListener('click', () => { loginTab.classList.add('active'); if(signupTab) signupTab.classList.remove('active'); if(loginForm) loginForm.classList.remove('hidden'); if(signupForm) signupForm.classList.add('hidden'); }); if(signupTab) signupTab.addEventListener('click', () => { signupTab.classList.add('active'); if(loginTab) loginTab.classList.remove('active'); if(signupForm) signupForm.classList.remove('hidden'); if(loginForm) loginForm.classList.add('hidden'); });
    if(loginForm) loginForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; const errorP = document.getElementById('login-error'); if(errorP) errorP.textContent = ''; try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Login Error:", error); if(errorP) errorP.textContent = error.message; } }); if(signupForm) signupForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('signup-email').value; const password = document.getElementById('signup-password').value; const name = document.getElementById('signup-name').value; const phone = document.getElementById('signup-phone').value; const address = document.getElementById('signup-address').value; const city = document.getElementById('signup-city').value; const district = document.getElementById('signup-district').value; const postalCode = document.getElementById('signup-postal-code').value; const errorP = document.getElementById('signup-error'); if(errorP) errorP.textContent = ''; try { const userCredential = await createUserWithEmailAndPassword(auth, email, password); const user = userCredential.user; await setDoc(doc(db, "users", user.uid), { name: name, email: email, phone: phone, address: address, city: city, district: district, postalCode: postalCode, createdAt: serverTimestamp(), role: "customer" }); } catch (error) { console.error("Signup Error:", error); if(errorP) errorP.textContent = error.message; } }); if(logoutBtnNav) logoutBtnNav.addEventListener('click', () => { signOut(auth); });

    const getCart = () => JSON.parse(localStorage.getItem('mobileHubCart')) || [];
    const saveCart = (cart) => localStorage.setItem('mobileHubCart', JSON.stringify(cart));
    const updateCartCountBadge = () => { const cart = getCart(); const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0); const cartTotalValue = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0); if (cartCountBadge) { if (totalItems > 0) { cartCountBadge.textContent = totalItems; cartCountBadge.classList.remove('hidden'); cartCountBadge.classList.add('pop'); setTimeout(() => cartCountBadge.classList.remove('pop'), 200); } else { cartCountBadge.textContent = '0'; cartCountBadge.classList.add('hidden', 'pop'); } } const cartTotalText = document.querySelector('#cart-icon span.md\\:inline'); if (cartTotalText) { cartTotalText.textContent = `Rs.${cartTotalValue.toLocaleString('en-US', { minimumFractionDigits: 2 })}`; } };

    const renderCartModal = () => { const cart = getCart(); let total = 0; if (!cartItemsContainer || !cartTotalEl) return; if (cart.length === 0) { cartItemsContainer.innerHTML = '<p class="text-slate-500 py-6 text-center">Your cart is empty.</p>'; cartTotalEl.textContent = 'Rs. 0.00'; return; } cartItemsContainer.innerHTML = cart.map(item => { total += item.price * item.quantity; return ` <div class="flex items-center gap-4 py-4"> <img src="${item.imageUrl || 'https://via.placeholder.com/64'}" alt="${item.name}" class="w-16 h-16 rounded object-contain mix-blend-multiply bg-slate-100 p-1"> <div class="flex-grow"> <h4 class="font-semibold text-sm text-slate-800">${item.name}</h4> <div class="flex items-center gap-2 my-1"> <button data-id="${item.id}" class="cart-qty-decrease w-6 h-6 font-bold rounded bg-slate-100 hover:bg-slate-200 flex items-center justify-center">-</button> <span class="w-6 text-center font-bold text-sm text-slate-700">${item.quantity}</span> <button data-id="${item.id}" class="cart-qty-increase w-6 h-6 font-bold rounded bg-slate-100 hover:bg-slate-200 flex items-center justify-center">+</button> </div> <p class="text-sm main-accent-color font-bold">Rs. ${item.price.toLocaleString('en-US', { minimumFractionDigits: 2 })}</p> </div> <button data-id="${item.id}" class="cart-remove-item text-slate-400 hover:text-red-500" title="Remove Item"> <i class="fas fa-times text-lg"></i> </button> </div>`; }).join(''); cartTotalEl.textContent = `Rs. ${total.toLocaleString('en-US', { minimumFractionDigits: 2 })}`; };
    if(cartIcon) cartIcon.addEventListener('click', (e) => { if (e.target.tagName === 'I' || e.target.tagName === 'SPAN') { e.preventDefault(); renderCartModal(); if(cartModal) cartModal.classList.remove('hidden'); } });
    if(closeCartBtn) closeCartBtn.addEventListener('click', () => { if(cartModal) cartModal.classList.add('hidden'); });
    if(cartModalBg) cartModalBg.addEventListener('click', () => { if(cartModal) cartModal.classList.add('hidden'); });
    if(cartModal) cartModal.addEventListener('click', (e) => { if (e.target === e.currentTarget || e.target === cartModalBg) return; const targetLink = e.target.closest('a'); if (targetLink && (targetLink.id === 'checkout-btn-modal' || targetLink.href.includes('cart.html'))) { return; } const targetButton = e.target.closest('button'); if (!targetButton) return; const id = targetButton.dataset.id; if (!id && targetButton.id !== 'clear-cart-btn') return; let cart = getCart(); let cartChanged = false; if (targetButton.id === 'clear-cart-btn') { if (confirm('Clear entire cart?')) { cart = []; cartChanged = true; } } else { const itemIndex = cart.findIndex(i => i.id === id); if(itemIndex === -1) return; if (targetButton.classList.contains('cart-qty-increase')) { cart[itemIndex].quantity++; cartChanged = true; } else if (targetButton.classList.contains('cart-qty-decrease')) { if (cart[itemIndex].quantity > 1) { cart[itemIndex].quantity--; cartChanged = true; } else { if (confirm('Remove item?')) { cart.splice(itemIndex, 1); cartChanged = true; } } } else if (targetButton.classList.contains('cart-remove-item')) { if (confirm('Remove item?')) { cart.splice(itemIndex, 1); cartChanged = true; } } } if (cartChanged) { saveCart(cart); renderCartModal(); updateCartCountBadge(); if (typeof renderCheckoutPage === 'function') renderCheckoutPage(); } });

    if(trackingIconBtn) trackingIconBtn.addEventListener('click', (e) => { 
        e.preventDefault(); 
        window.location.href = 'track.html'; // Navigate to track.html
        // if(trackingModal) trackingModal.classList.remove('hidden');
        // loadUserOrders(); 
    }); 
    if(closeTrackingBtn) closeTrackingBtn.addEventListener('click', () => { if(trackingModal) trackingModal.classList.add('hidden'); }); 
    const loadUserOrders = async () => { if(!trackingItemsContainer) return; trackingItemsContainer.innerHTML = '<p class="text-slate-500 text-center">Loading your orders...</p>'; const user = auth.currentUser; if (!user) { trackingItemsContainer.innerHTML = ` <div class="text-center p-8"> <h3 class="text-xl font-semibold text-slate-700 mb-4">Please Log In</h3> <p class="text-slate-500 mb-6">You need to be logged in to view your order history.</p> <button id="tracking-login-btn" class="main-accent-bg text-white px-6 py-2 rounded-md font-semibold main-accent-bg-hover">Login Now</button> </div>`; const trackingLoginBtn = document.getElementById('tracking-login-btn'); if (trackingLoginBtn) { trackingLoginBtn.addEventListener('click', () => { if(trackingModal) trackingModal.classList.add('hidden'); openModal(true); }); } return; } try { const q = query(ordersCol, where("userId", "==", user.uid), orderBy("createdAt", "desc")); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { trackingItemsContainer.innerHTML = ` <div class="text-center p-8"> <h3 class="text-xl font-semibold text-slate-700 mb-4">No Orders Found</h3> <p class="text-slate-500">You haven't placed any orders with us yet.</p> </div>`; return; } trackingItemsContainer.innerHTML = querySnapshot.docs.map(doc => { const order = doc.data() || {}; const orderId = doc.id; const createdDate = order.createdAt ? order.createdAt.toDate().toLocaleDateString('si-LK', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A'; const itemSummary = (order.items || []).map(item => `${item.name || 'Item'} (x${item.quantity || 1})`).join(', '); let statusColor = 'bg-slate-100 text-slate-700'; const statusLower = (order.status || 'Pending').toLowerCase(); if (statusLower === 'pending') statusColor = 'bg-yellow-100 text-yellow-800'; else if (statusLower === 'shipped' || statusLower === 'processing') statusColor = 'bg-blue-100 text-blue-800'; else if (statusLower === 'delivered') statusColor = 'bg-green-100 text-green-800'; else if (statusLower === 'cancelled') statusColor = 'bg-red-100 text-red-800'; return ` <div class="bg-white border rounded-lg p-4 mb-4 shadow-sm"> <div class="flex flex-col sm:flex-row justify-between items-start mb-3"> <div> <p class="text-xs text-slate-500">Order ID: ${orderId}</p> <p class="font-bold text-lg text-slate-800">Total: Rs. ${(order.totalAmount || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}</p> </div> <span class="text-sm font-bold px-3 py-1 rounded-full ${statusColor} mt-2 sm:mt-0">${order.status || 'Pending'}</span> </div> <p class="text-sm text-slate-600 mb-2"><strong>Placed On:</strong> ${createdDate}</p> <p class="text-sm text-slate-600 mb-3 break-words"><strong>Items:</strong> ${itemSummary || 'No items found'}</p> <div class="bg-slate-50 p-3 rounded-md"> <p class="text-sm font-semibold text-slate-700">Shipping to: ${order.customerInfo?.name || 'N/A'}</p> <p class="text-xs text-slate-500">${order.customerInfo?.address || 'N/A'}, ${order.customerInfo?.city || ''}</p> </div> </div>`; }).join(''); } catch (error) { console.error("Error fetching orders: ", error); trackingItemsContainer.innerHTML = '<p class="text-red-500 text-center">Could not load your orders. Please try again later.</p>'; } };

    const prefillCheckoutForm = (userData) => {
        if(!userData) return;
        const firstNameInput = document.getElementById('first-name');
        const lastNameInput = document.getElementById('last-name');
        const emailInput = document.getElementById('email');
        const mobileInput = document.getElementById('mobile');
        const addressInput = document.getElementById('address');
        const cityInput = document.getElementById('city');
        const districtInput = document.getElementById('district');
        const postalCodeInput = document.getElementById('postal-code');

        if (emailInput) emailInput.value = userData.email || '';
        if (mobileInput) mobileInput.value = userData.phone || '';
        if (addressInput) addressInput.value = userData.address || '';
        if (cityInput) cityInput.value = userData.city || '';
        if (districtInput) districtInput.value = userData.district || '';
        if (postalCodeInput) postalCodeInput.value = userData.postalCode || '';

        if (firstNameInput && lastNameInput && userData.name) {
            const nameParts = userData.name.split(' ');
            firstNameInput.value = nameParts[0] || '';
            lastNameInput.value = nameParts.slice(1).join(' ') || '';
        }
    };
    
    const renderCheckoutPage = () => {
        const cart = getCart();
        let finalTotal = 0;
        let originalTotal = 0;

        if (!checkoutItemsList || !checkoutTotalEl || !checkoutDiscountEl || !checkoutPayableEl) return;

        if (cart.length === 0) {
            checkoutPage.innerHTML = '<p class="text-slate-500 text-lg text-center py-20">Your cart is empty. <a href="index.html" class="main-accent-color font-semibold hover:underline">Start shopping!</a></p>';
            return;
        }

        const proceedToPayBtn = document.getElementById('proceed-to-pay-btn');
        if (proceedToPayBtn) { proceedToPayBtn.disabled = false; }

        checkoutItemsList.innerHTML = cart.map(item => {
            finalTotal += item.price * item.quantity;
            originalTotal += (item.originalPrice || item.price) * item.quantity;
            return `
            <div class="flex justify-between items-center gap-4 py-2 border-b">
                <div class="flex items-center gap-3">
                    <img src="${item.imageUrl || 'https://via.placeholder.com/64'}" alt="${item.name}" class="w-12 h-12 object-contain rounded border">
                    <div class="flex-1">
                        <p class="font-semibold text-sm text-slate-800">${item.name} <span class="text-gray-500 font-normal">x ${item.quantity}</span></p>
                         ${ (item.originalPrice && item.originalPrice > item.price) ? `<p class="text-xs text-gray-500 line-through">Rs. ${item.originalPrice.toLocaleString('en-US', { minimumFractionDigits: 2 })}</p>` : '' }
                    </div>
                </div>
                <p class="text-sm font-semibold text-slate-800">
                    Rs. ${(item.price * item.quantity).toLocaleString('en-US', { minimumFractionDigits: 2 })}
                </p>
            </div>`;
        }).join('');

        const discount = originalTotal - finalTotal;
        checkoutTotalEl.textContent = `Rs. ${originalTotal.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
        checkoutDiscountEl.textContent = `Rs. ${discount.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
        checkoutPayableEl.textContent = `Rs. ${finalTotal.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;

        if (paymentCallRadio && paymentCodRadio) {
            if (finalTotal > 10000) {
                paymentCallRadio.checked = true;
            } else {
                paymentCodRadio.checked = true;
            }
        }

        if(currentUserDetails) {
            prefillCheckoutForm(currentUserDetails);
        }
    };

    if(checkoutPage) checkoutPage.addEventListener('click', async (e) => {
        const proceedButton = e.target.closest('#proceed-to-pay-btn');
        if(proceedButton){
            e.preventDefault();
            const form = document.getElementById('checkout-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            const formData = new FormData(form);
            currentOrderDetails = Object.fromEntries(formData.entries());
            const payableAmount = checkoutPayableEl.textContent;
            if (paymentPayableAmountEl) { paymentPayableAmountEl.textContent = payableAmount; }
            checkoutPage.classList.add('hidden');
            paymentPage.classList.remove('hidden');
            window.scrollTo(0, 0);
            return;
        }
    });

    if(paymentPage) paymentPage.addEventListener('click', async (e) => {
        const confirmBtn = e.target.closest('#confirm-order-btn');
        if(confirmBtn){
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<div class="loader h-6 w-6 border-2 border-t-amber-500 mx-auto"></div>';
            
            const selectedPaymentRadio = document.querySelector('input[name="payment-method"]:checked');
            if (!selectedPaymentRadio) {
                 alert("Please select a payment method.");
                 confirmBtn.disabled = false;
                 confirmBtn.innerHTML = 'Confirm Order';
                 return;
            }
            const selectedPayment = selectedPaymentRadio.value;
            
            const currentUser = auth.currentUser;
            let totalNumber = 0;
            try {
               if (paymentPayableAmountEl) { 
                   const paymentAmountText = paymentPayableAmountEl.textContent;
                   totalNumber = parseFloat( paymentAmountText.replace("Rs. ", "").replace(/,/g, "") );
                   if (isNaN(totalNumber)) { totalNumber = 0; }
               }
            } catch (parseError){ console.error("Error parsing total amount:", parseError); }
            
            const cart = getCart();
            const originalTotalForOrder = cart.reduce((sum, item) => sum + (item.originalPrice || item.price) * item.quantity, 0);
            const discountAmountForOrder = originalTotalForOrder - totalNumber;

            const customerInfoObject = {
                name: `${currentOrderDetails['first-name'] || ''} ${currentOrderDetails['last-name'] || ''}`.trim(),
                email: currentOrderDetails.email || 'N/A',
                phone: currentOrderDetails.mobile || 'N/A',
                address: currentOrderDetails.address || 'N/A',
                city: currentOrderDetails.city || 'N/A',
                district: currentOrderDetails.district || 'N/A',
                postalCode: currentOrderDetails['postal-code'] || 'N/A',
                orderNotes: currentOrderDetails.orderNotes || ''
            };

            const paymentMethod = selectedPayment === 'cod' ? 'Cash on Delivery' : 'Call Confirmation';
            const status = selectedPayment === 'cod' ? 'Pending' : 'Pending - Call';

            try {
                const docRef = await addDoc(ordersCol, {
                    customerInfo: customerInfoObject,
                    totalAmount: totalNumber,
                    discountAmount: discountAmountForOrder,
                    originalTotal: originalTotalForOrder,
                    items: cart,
                    paymentMethod: paymentMethod,
                    createdAt: serverTimestamp(),
                    status: status,
                    userId: currentUser ? currentUser.uid : "Guest"
                });

                saveCart([]);
                currentOrderDetails = {};
                paymentPage.classList.add('hidden');

                if (selectedPayment === 'cod') {
                    if (successOrderId) successOrderId.textContent = docRef.id;
                    if (codSuccessModal) codSuccessModal.classList.remove('hidden');
                } else {
                    if (callSuccessModal) callSuccessModal.classList.remove('hidden');
                    setTimeout(() => { window.location.href = 'index.html'; }, 4000); 
                }

            } catch (error) {
                console.error("Error placing order: ", error);
                alert("There was an error placing your order. Please try again.");
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = 'Confirm Order';
            }
            return;
        }

        if(e.target.closest('#back-to-checkout-btn')){
            e.preventDefault();
            paymentPage.classList.add('hidden');
            checkoutPage.classList.remove('hidden');
            window.scrollTo(0, 0);
            return;
        }
    });

    if(copyOrderIdBtn) {
        copyOrderIdBtn.addEventListener('click', () => {
            const orderId = successOrderId.textContent;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(orderId).then(() => {
                    copyOrderIdBtn.textContent = 'Copied!';
                    setTimeout(() => { copyOrderIdBtn.textContent = 'Copy'; }, 2000);
                }, (err) => { alert('Failed to copy. Please copy manually.'); });
            } else { alert('Failed to copy. Please copy manually.'); }
        });
    }

    if(trackOrderBtn) {
         trackOrderBtn.addEventListener('click', () => {
              window.location.href = 'track.html'; // Changed to navigate
         });
    }

    const renderCategoryNavForSearch = (categories) => { if(searchCategoryDropdown) { let dropdownHTML = `<option value="all">ALL CATEGORIES</option>`; dropdownHTML += categories.map(cat => `<option value="${cat.name}">${cat.name.toUpperCase()}</option>`).join(''); searchCategoryDropdown.innerHTML = dropdownHTML; } };
    onSnapshot(query(categoriesCol, orderBy("name")), (snapshot) => { categoriesCache = snapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name })); renderCategoryNavForSearch(categoriesCache); }, error => console.error("Error fetching categories:", error));

    document.addEventListener('click', async (e) => {
       if (e.target.closest('#tracking-login-btn')) { e.preventDefault(); if(trackingModal) trackingModal.classList.add('hidden'); openModal(true); return; }
       if (e.target.closest('#search-icon-btn')) {
            const searchTerm = searchBar.value.trim();
            const selectedCategory = searchCategoryDropdown.value;
            let url = 'index.html?';
            if (searchTerm) url += `search=${encodeURIComponent(searchTerm)}`;
            if (selectedCategory !== 'all') url += `${searchTerm ? '&' : ''}category=${encodeURIComponent(selectedCategory)}`;
            if (url !== 'index.html?') { window.location.href = url; }
       }
    });
     if (searchBar) { searchBar.addEventListener('keypress', (e) => { if (e.key === 'Enter') { const searchTerm = searchBar.value.trim(); const selectedCategory = searchCategoryDropdown.value; let url = 'index.html?'; if (searchTerm) url += `search=${encodeURIComponent(searchTerm)}`; if (selectedCategory !== 'all') url += `${searchTerm ? '&' : ''}category=${encodeURIComponent(selectedCategory)}`; if (url !== 'index.html?') { window.location.href = url; } } }); }
     if (searchCategoryDropdown) { searchCategoryDropdown.addEventListener('change', () => { const searchTerm = searchBar.value.trim(); const selectedCategory = searchCategoryDropdown.value; let url = 'index.html?'; if (searchTerm) url += `search=${encodeURIComponent(searchTerm)}`; if (selectedCategory !== 'all') url += `${searchTerm ? '&' : ''}category=${encodeURIComponent(selectedCategory)}`; if (url !== 'index.html?') { window.location.href = url; } else if (!searchTerm && selectedCategory === 'all') { window.location.href = 'index.html'; } }); }
    if (logoBtn) { logoBtn.addEventListener('click', (e) => { e.preventDefault(); window.location.href = 'index.html'; }); }

    updateCartCountBadge();
    renderCheckoutPage();
    renderCartModal();

</script>

</body>
</html>